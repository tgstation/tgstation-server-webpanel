"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[3763],{3763:function(e,t,a){a.r(t);var n=a(7875),i=a(6188),s=a(6784),c=a(6540),l=a(5038),r=a(3524),o=a(5615),d=a(8065),h=a(8798),m=a(4614),p=a(2576),u=a(4173),f=a(5301),g=a(7621),E=a(4118),C=a(7567),v=a(1723),y=a(6113),B=a(6795),S=a(7255);function w(){return w=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},w.apply(null,arguments)}var A=function(e){return e[e.Always=0]="Always",e[e.OnError=1]="OnError",e[e.Never=2]="Never",e}(A||{}),x=function(e){return e[e.Server=0]="Server",e[e.SASL=1]="SASL",e[e.NickServ=2]="NickServ",e}(x||{});class b extends c.Component{constructor(e){super(e),this.state={loading:!0,errors:[],chatBots:[],selectedAddNode:!1,selectedChatBot:null,selectedChannel:null,addBotProvider:p.k_.Discord,flashExport:!1},this.renderChatBotBrowser=this.renderChatBotBrowser.bind(this)}async componentDidMount(){(0,E.OQ)(this.context.instancePermissionSet,p.B5.Read)?await this.refresh():this.setState({loading:!1})}addError(e){this.setState((t=>{const a=Array.from(t.errors);return a.push(e),{errors:a}}))}async refresh(){if((0,E.OQ)(this.context.instancePermissionSet,p.B5.Read)){this.setState({loading:!0});let e=1,t=[];for(let a=1;a<=e;++a){const n=await m.A.listChatBots(this.context.instance.id,{page:a});if(n.code!==f.s.OK){this.addError(n.error);break}e=n.payload.totalPages,t=t.concat(n.payload.content)}t.forEach((e=>e.loadedWithConnectionString=!1)),this.setState({chatBots:t,loading:!1})}}async addChatBot(e){let t,a,n;if(!e.name)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.name"}));switch(e.provider){case p.k_.Discord:if(a=e,!a.botToken)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.token"}));t=`${a.botToken};${a.dmOutputDisplay};0;${a.deploymentBranding?"1":"0"}`;break;case p.k_.Irc:if(n=e,!n.address)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.address"}));if(!n.nickname)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.nick"}));t=`${n.address};${n.port};${n.nickname};${n.useSsl?"1":"0"}`,n.password&&(t+=`;${n.passwordType};${n.password}`);break;default:throw new Error("Bad provider!")}this.setState({loading:!0});const i=await m.A.createChatBot(this.context.instance.id,{provider:e.provider,name:e.name,enabled:e.enabled,connectionString:t,channelLimit:e.channelLimit,reconnectionInterval:e.reconnectionInterval});if(i.code===f.s.OK){const e=i.payload;e.loadedWithConnectionString=!0;const t=[...this.state.chatBots];t.push(e),this.setState({chatBots:t,selectedChatBot:e,selectedAddNode:!1})}else this.addError(i.error);this.setState({loading:!1})}async reloadChatBot(e){this.setState({loading:!0});const t=await m.A.getChatBot(this.context.instance.id,e.id);if(t.code===f.s.OK){(e=t.payload).loadedWithConnectionString=!0;const a=[...this.state.chatBots],n=a.indexOf(e);a[n]=e,this.setState({chatBots:a,selectedChatBot:e})}else this.addError(t.error);this.setState({loading:!1})}async editChatBot(e){this.setState({loading:!0});let t=this.state.selectedChatBot;const a=await m.A.updateChatBot(this.context.instance.id,{...e,id:t.id});if(a.code===f.s.OK){if(a.payload){const e=[...this.state.chatBots],n=e.indexOf(t);t=a.payload,t.loadedWithConnectionString=!0,e[n]=t,this.setState({chatBots:e,selectedChatBot:t})}}else this.addError(a.error);this.setState({loading:!1})}async addChatChannel(e,t){if(!t.channelData)return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.missing.channel"}));if(e.provider===p.k_.Discord){if(!new RegExp("^[0-9]+$").test(t.channelData))return void alert(this.props.intl.formatMessage({id:"view.instance.chat.create.invalid.discord"}))}this.setState({loading:!0});const a=[...e.channels??[]];a.push(t);const n=await m.A.updateChatBot(this.context.instance.id,{channels:a,id:e.id});if(n.code===f.s.OK){if(n.payload){const t=[...this.state.chatBots],a=t.indexOf(e);(e=n.payload).loadedWithConnectionString=!0,t[a]=e,this.setState({chatBots:t,selectedChatBot:e,selectedChannel:e.channels[e.channels.length-1]})}}else this.addError(n.error);this.setState({loading:!1})}async editChatChannel(e,t){this.setState({loading:!0});const a=[...e.channels??[]],n=a[a.indexOf(this.state.selectedChannel)];Object.assign(n,t);const i=await m.A.updateChatBot(this.context.instance.id,{channels:a,id:e.id});if(i.code===f.s.OK){if(i.payload){const t=[...this.state.chatBots],a=t.indexOf(e);(e=i.payload).loadedWithConnectionString=!0,t[a]=e,this.setState({chatBots:t,selectedChatBot:e})}}else this.addError(i.error);this.setState({loading:!1})}async deleteChatChannel(e,t){if(!confirm(this.props.intl.formatMessage({id:"view.instance.chat.delete.channel.confirm"},{channelName:t.tag??t.channelData})))return;this.setState({loading:!0});const a=[...e.channels??[]],n=a.indexOf(t);a.splice(n,1);const i=await m.A.updateChatBot(this.context.instance.id,{channels:a,id:e.id});if(i.code===f.s.OK){if(i.payload){const t=[...this.state.chatBots],a=t.indexOf(e);(e=i.payload).loadedWithConnectionString=!0,t[a]=e,this.setState({chatBots:t,selectedChatBot:e,selectedChannel:null})}}else this.addError(i.error);this.setState({loading:!1})}async deleteChatBot(e){if(!confirm(this.props.intl.formatMessage({id:"view.instance.chat.delete.confirm"},{botName:e.name})))return;this.setState({loading:!0});const t=await m.A.deleteChatBot(this.context.instance.id,e.id);if(t.code===f.s.OK){const t=[...this.state.chatBots],a=t.indexOf(e);t.splice(a,1),this.setState({chatBots:t,selectedChatBot:null})}else this.addError(t.error);this.setState({loading:!1})}render(){if(this.state.loading)return c.createElement(S.default,{text:"loading.chat"});const e=(0,E.OQ)(this.context.instancePermissionSet,p.B5.Read),t=(0,E.OQ)(this.context.instancePermissionSet,p.B5.Create);return c.createElement("div",{className:"text-center"},c.createElement(B.Q,{obj:this.state}),c.createElement("h1",null,c.createElement(d.A,{id:"view.instance.chat"})),this.state.errors.map(((e,t)=>{if(e)return c.createElement(C.Ay,{key:t,error:e,onClose:()=>this.setState((e=>{const a=Array.from(e.errors);return a[t]=void 0,{errors:a}}))})})),c.createElement("div",{className:"d-flex flex-row"},c.createElement("div",{className:"text-left",style:{paddingRight:"16px",maxHeight:"800px",minWidth:"300px",overflowY:"scroll"}},c.createElement("ul",{className:"browser-ul"},e?this.state.chatBots.map(this.renderChatBotBrowser):c.createElement(c.Fragment,null),t?c.createElement("li",{className:"browser-li"},c.createElement(l.A,{placement:"top",show:!(this.state.chatBots.length<this.context.instance.chatBotLimit)&&void 0,overlay:e=>c.createElement(r.A,w({id:"too-many-chat-bots"},e),c.createElement(d.A,{id:"view.instance.chat.limit",values:{max:this.context.instance.chatBotLimit}}))},c.createElement(o.A,{className:"nowrap",disabled:this.state.chatBots.length>=this.context.instance.chatBotLimit,onClick:()=>this.setState({selectedChatBot:null,selectedChannel:null,selectedAddNode:!(this.state.selectedAddNode&&!this.state.selectedChatBot)})},c.createElement(s.g,{icon:i.QLR}),"\xa0",c.createElement(d.A,{id:"view.instance.chat.create"})))):c.createElement(c.Fragment,null))),c.createElement("div",{className:"flex-fill flex-column text-center align-self-center",style:{padding:"16px"}},this.state.selectedChannel?this.renderAddEditChannel(!1):this.state.selectedChatBot&&!this.state.selectedAddNode?this.renderAddEditChatBot(!1):this.state.selectedAddNode?this.state.selectedChatBot?this.renderAddEditChannel(!0):this.renderAddEditChatBot(!0):c.createElement("h4",null,c.createElement(d.A,{id:"view.instance.chat.select_item"})))))}renderChatBotBrowser(e){const t=this.state.selectedChatBot===e,a=(0,E.OQ)(this.context.instancePermissionSet,p.B5.WriteChannels);return c.createElement("li",{key:e.id,className:"browser-li"},c.createElement(o.A,{variant:t?"secondary":"primary",onClick:()=>this.setState((a=>({selectedChatBot:!t||this.state.selectedChannel||this.state.selectedAddNode?e:null,selectedChannel:null,selectedAddNode:!1,addBotProvider:t?a.addBotProvider:e.provider}))),className:"nowrap"},c.createElement(s.g,{icon:e.provider===p.k_.Discord?n._2G:i.DN2}),"\xa0",e.name),a&&t?c.createElement("ul",{className:"browser-ul"},e.channels.map((e=>{const t=this.state.selectedChannel===e;return c.createElement("li",{key:e.channelData,className:"browser-li"},c.createElement(o.A,{variant:t?"secondary":"primary",onClick:()=>this.setState({selectedChannel:t?null:e}),className:"nowrap"},c.createElement(s.g,{icon:i.CYF}),"\xa0",e.tag?`(${e.tag})`:e.channelData))})),c.createElement("li",{className:"browser-li"},c.createElement(l.A,{placement:"top",show:!(e.channels.length<e.channelLimit)&&void 0,overlay:t=>c.createElement(r.A,w({id:"too-many-chat-channels"},t),c.createElement(d.A,{id:"view.instance.chat.limit.channels",values:{max:e.channelLimit}}))},c.createElement(o.A,{className:"nowrap",disabled:e.channels.length>=e.channelLimit,onClick:()=>this.setState({selectedChannel:null,selectedAddNode:!(this.state.selectedAddNode&&!this.state.selectedChannel)})},c.createElement(s.g,{icon:i.QLR}),"\xa0",c.createElement(d.A,{id:"view.instance.chat.create.channel"}))))):c.createElement(c.Fragment,null))}async exportChannelsToClipboard(){const e=this.state.selectedChatBot.channels,t=JSON.stringify(e);await navigator.clipboard.writeText(t),this.setState({flashExport:!0}),await new Promise((e=>setTimeout(e,2e3))),this.setState({flashExport:!1})}async importChannelsFromClipboard(){let e,t;if(this.setState({loading:!0}),navigator.clipboard.readText)e=await navigator.clipboard.readText();else if(e=prompt("Your browser doesn't allow clipboard reading. Please paste your entry here."),!e)return void this.setState({loading:!1});try{t=JSON.parse(e)}catch(e){const t=e instanceof Error?{jsError:e}:{void:!0};return this.addError(new u.Ay(u.O4.BAD_CHANNELS_JSON,t)),void this.setState({loading:!1})}let a=this.state.selectedChatBot;const n=await m.A.updateChatBot(this.context.instance.id,{channels:t,id:a.id});if(n.code===f.s.OK){if(n.payload){const e=[...this.state.chatBots],t=e.indexOf(a);a=n.payload,a.loadedWithConnectionString=!0,e[t]=a,this.setState({chatBots:e,selectedChatBot:a})}}else this.addError(n.error);this.setState({loading:!1})}renderAddEditChatBot(e){const t={type:v.PU.Enum,name:"fields.instance.chat.provider",defaultValue:this.state.addBotProvider,enum:p.k_,noLocalize:!0},a={...t,onChange:e=>{this.setState({addBotProvider:e})}},h={provider:{...t},name:{type:v.PU.String,name:"fields.instance.chat.name",tooltip:"fields.instance.chat.name.tip"},enabled:{type:v.PU.Boolean,name:"fields.instance.chat.enabled",tooltip:"fields.instance.chat.enabled.tip",defaultValue:!0},channelLimit:{type:v.PU.Number,name:"fields.instance.chat.limit",tooltip:"fields.instance.chat.limit.tip",min:0,max:65535,defaultValue:10},reconnectionInterval:{type:v.PU.Number,name:"fields.instance.chat.reconnect",tooltip:"fields.instance.chat.reconnect.tip",min:0,defaultValue:5}};if(e){const e={...h,botToken:{type:v.PU.Password,name:"fields.instance.chat.create.discord.token",tooltip:"fields.instance.chat.create.discord.token.tip"},dmOutputDisplayType:{type:v.PU.Enum,name:"fields.instance.chat.create.discord.output",tooltip:"fields.instance.chat.create.discord.output.tip",defaultValue:A.Always,enum:A,noLocalize:!0},deploymentBranding:{type:v.PU.Boolean,name:"fields.instance.chat.create.discord.branding",tooltip:"fields.instance.chat.create.discord.branding.tip",defaultValue:!0}},t={...h,address:{type:v.PU.String,name:"fields.instance.chat.create.irc.address",tooltip:"fields.instance.chat.create.irc.address.tip"},port:{type:v.PU.Number,name:"fields.instance.chat.create.irc.port",min:1,max:65535,defaultValue:6697},nickname:{type:v.PU.String,name:"fields.instance.chat.create.irc.nick"},password:{type:v.PU.Password,name:"fields.instance.chat.create.irc.pass",tooltip:"fields.instance.chat.create.irc.pass.tip"},passwordType:{type:v.PU.Enum,name:"fields.instance.chat.create.irc.passtype",defaultValue:x.SASL,enum:x,noLocalize:!0},useSsl:{type:v.PU.Boolean,name:"fields.instance.chat.create.irc.ssl",tooltip:"fields.instance.chat.create.irc.ssl.tip"}};return h.provider.disabled=!0,c.createElement(c.Fragment,null,c.createElement("h5",null,c.createElement(d.A,{id:"view.instance.chat.create"})),c.createElement("hr",null),c.createElement(v.Ay,a),c.createElement("hr",null),c.createElement(y.A,{key:`bot-create-form-${this.state.addBotProvider}`,hideDisabled:!0,includeAll:!0,saveMessageId:"fields.instance.chat.create.save",fields:this.state.addBotProvider===p.k_.Discord?e:t,onSave:e=>{this.addChatBot(e)}}))}const m=this.state.selectedChatBot,u=(0,E.OQ)(this.context.instancePermissionSet,p.B5.ReadConnectionString),f=(0,E.OQ)(this.context.instancePermissionSet,p.B5.WriteConnectionString),g={...h,connectionString:{type:v.PU.String,name:"fields.instance.chat.edit.connection",tooltip:"fields.instance.chat.edit.connection.tip",defaultValue:u?m.loadedWithConnectionString?m.connectionString:this.props.intl.formatMessage({id:"fields.instance.chat.edit.connection.unloaded"}):this.props.intl.formatMessage({id:"fields.instance.chat.edit.connection.deny"}),disabled:!f}};g.name.defaultValue=m.name,g.enabled.defaultValue=m.enabled,g.channelLimit.defaultValue=m.channelLimit,g.reconnectionInterval.defaultValue=m.reconnectionInterval,g.name.disabled=!(0,E.OQ)(this.context.instancePermissionSet,p.B5.WriteName),g.enabled.disabled=!(0,E.OQ)(this.context.instancePermissionSet,p.B5.WriteEnabled),g.channelLimit.disabled=!(0,E.OQ)(this.context.instancePermissionSet,p.B5.WriteChannelLimit),g.reconnectionInterval.disabled=!(0,E.OQ)(this.context.instancePermissionSet,p.B5.WriteReconnectionInterval);const C=(0,E.OQ)(this.context.instancePermissionSet,p.B5.Delete),B=(0,E.OQ)(this.context.instancePermissionSet,p.B5.WriteChannels);return c.createElement(c.Fragment,null,c.createElement("h5",null,c.createElement(s.g,{icon:m.provider===p.k_.Discord?n._2G:i.DN2}),"\xa0",m.name),c.createElement("hr",null),m.loadedWithConnectionString?c.createElement(c.Fragment,null):c.createElement(c.Fragment,null,c.createElement(l.A,{placement:"top",show:!u&&void 0,overlay:e=>c.createElement(r.A,w({id:"chat-bot-read-conn-perm"},e),c.createElement(d.A,{id:"view.instance.chat.reload.deny"}))},c.createElement(o.A,{className:"nowrap",disabled:!u,onClick:()=>{this.reloadChatBot(m)}},c.createElement(d.A,{id:"view.instance.chat.reload"}))),c.createElement("br",null),c.createElement("br",null)),c.createElement(y.A,{fields:g,onSave:e=>{this.editChatBot(e)}}),c.createElement("hr",null),c.createElement("div",{className:"text-center mb-3"},c.createElement(l.A,{placement:"top",show:!C&&void 0,overlay:e=>c.createElement(r.A,w({id:"chat-bot-delete-perm"},e),c.createElement(d.A,{id:"view.instance.chat.delete.deny"}))},c.createElement(o.A,{className:"nowrap mx-2",disabled:!C,variant:"danger",onClick:()=>{this.deleteChatBot(m)}},c.createElement(s.g,{icon:i.yLS}),"\xa0",c.createElement(d.A,{id:"view.instance.chat.delete"}))),navigator.clipboard?c.createElement(c.Fragment,null,c.createElement(o.A,{className:"nowrap mx-2",variant:this.state.flashExport?"success":"secondary",onClick:()=>{this.exportChannelsToClipboard()}},this.state.flashExport?c.createElement(s.g,{icon:i.e68}):c.createElement(c.Fragment,null,c.createElement(s.g,{icon:i.KTq}),c.createElement(s.g,{icon:i.CeG})),"\xa0",c.createElement(d.A,{id:"view.instance.chat.channels.export"})),c.createElement(l.A,{placement:"top",show:!B&&void 0,overlay:e=>c.createElement(r.A,w({id:"chat-bot-edit-channels-perm"},e),c.createElement(d.A,{id:"view.instance.chat.channels.deny"}))},c.createElement(o.A,{className:"nowrap mx-2",disabled:!B,variant:"primary",onClick:()=>{this.importChannelsFromClipboard()}},c.createElement(s.g,{icon:i.KTq}),c.createElement(s.g,{icon:i.dmS}),"\xa0",c.createElement(d.A,{id:"view.instance.chat.channels.import"})))):null))}renderAddEditChannel(e){const t=this.state.selectedChatBot,a={tag:{type:v.PU.String,name:"fields.instance.chat.channel.tag",tooltip:"fields.instance.chat.channel.tag.tip"},isAdminChannel:{type:v.PU.Boolean,name:"fields.instance.chat.channel.admin",tooltip:"fields.instance.chat.channel.admin.tip"},isWatchdogChannel:{type:v.PU.Boolean,name:"fields.instance.chat.channel.watchdog",tooltip:"fields.instance.chat.channel.watchdog.tip"},isUpdatesChannel:{type:v.PU.Boolean,name:"fields.instance.chat.channel.updates",tooltip:"fields.instance.chat.channel.updates.tip"},isSystemChannel:{type:v.PU.Boolean,name:"fields.instance.chat.channel.system",tooltip:"fields.instance.chat.channel.system.tip"}},n=(0,E.OQ)(this.context.instancePermissionSet,p.B5.WriteChannels);if(e){const e={channelData:{type:v.PU.String,name:"fields.instance.chat.channel.discord",tooltip:"fields.instance.chat.channel.discord.tip"},...a},n={channelData:{type:v.PU.String,name:"fields.instance.chat.channel.irc",tooltip:"fields.instance.chat.channel.irc.tip",defaultValue:"#"},...a};return c.createElement(c.Fragment,null,c.createElement("h5",null,c.createElement(d.A,{id:"view.instance.chat.create.channel"})),c.createElement("hr",null),c.createElement(y.A,{key:`bot-channel-create-form-${t.provider}`,includeAll:!0,saveMessageId:"fields.instance.chat.create.channel",fields:t.provider===p.k_.Discord?e:n,onSave:e=>{this.addChatChannel(t,e)}}))}const i=this.state.selectedChannel;return a.isAdminChannel.defaultValue=i.isAdminChannel,a.isUpdatesChannel.defaultValue=i.isUpdatesChannel,a.isWatchdogChannel.defaultValue=i.isWatchdogChannel,a.isSystemChannel.defaultValue=i.isSystemChannel,a.tag.defaultValue=i.tag,c.createElement(c.Fragment,{key:t.channels.indexOf(i)},c.createElement("h5",null,i.channelData,i.tag?` (${i.tag})`:""),c.createElement("hr",null),c.createElement(y.A,{fields:a,onSave:e=>{const a={channelData:this.state.selectedChannel.channelData,...e};this.editChatChannel(t,a)}}),c.createElement("hr",null),c.createElement(l.A,{placement:"top",show:!n&&void 0,overlay:e=>c.createElement(r.A,w({id:"chat-bot-delete-perm"},e),c.createElement(d.A,{id:"view.instance.chat.delete.channel.deny"}))},c.createElement(o.A,{className:"nowrap",disabled:!n,variant:"danger",onClick:()=>{this.deleteChatChannel(t,i)}},c.createElement(d.A,{id:"view.instance.chat.delete.channel"}))))}}b.contextType=g.z,t.default=(0,h.Ay)(b)}}]);
//# sourceMappingURL=3763.db66f3ae50d872533081.bundle.js.map
"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[240],{8425:function(e,t,n){n.d(t,{t:function(){return l}});var r=n(67294),s=n(55171),a=n.n(s),i=n(27961);function o(e){return r.createElement(a(),{src:e.obj,name:"JSON",theme:"tube",iconStyle:"triangle",collapsed:!0,displayDataTypes:!1})}function l(e){return i.ZP.showjson.value?r.createElement("div",{className:"text-left"},r.createElement(o,{obj:e.obj})):r.createElement(r.Fragment,null)}},89929:function(e,t,n){n.d(t,{Z:function(){return h}});var r=n(67814),s=n(67294),a=n(35005),i=n(32258),o=n(15293),l=n(38966),c=n(19611),d=n(44012);function m(){return m=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},m.apply(this,arguments)}class h extends s.PureComponent{constructor(e){super(e),this.state={showGoto:!1,gotoValue:e.currentPage}}render(){const e=[],t=Math.max(this.props.totalPages-this.props.currentPage-1,0),n=Math.max(this.props.currentPage-2,0),h=Math.max(this.props.currentPage-Math.max(5-Number(this.props.currentPage!==this.props.totalPages)-t,2),2),u=Math.min(this.props.currentPage+Math.max(5-Number(1!==this.props.currentPage)-n,2),this.props.totalPages-1);for(let t=h;t<=u;t++)e.push(s.createElement(l.Z.Item,{key:t,active:t===this.props.currentPage,onClick:()=>this.props.selectPage(t)},t));const p=this.props.totalPages>7?s.createElement(l.Z.Ellipsis,{disabled:!0}):null,g=s.createElement(c.Z,{id:"popover-gotopage"},s.createElement(c.Z.Title,null,s.createElement(d.Z,{id:"generic.goto.title"})),s.createElement(c.Z.Content,null,s.createElement("form",{className:"d-flex",onSubmit:e=>{e.preventDefault(),this.props.selectPage(this.state.gotoValue),this.setState({showGoto:!1})}},s.createElement(i.Z.Control,{className:"mr-2",type:"number",min:1,max:this.props.totalPages,value:this.state.gotoValue,onChange:e=>this.setState({gotoValue:parseInt(e.target.value)}),custom:!0}),s.createElement(a.Z,{type:"submit"},s.createElement(d.Z,{id:"generic.goto"}))))),{selectPage:y,totalPages:w,currentPage:E,...v}=this.props;return s.createElement("div",m({className:"text-center",style:{position:"sticky",bottom:"1.5em"}},v),s.createElement(l.Z,{className:"justify-content-center"},s.createElement(l.Z.Prev,{disabled:this.props.currentPage<=1,onClick:()=>this.props.selectPage(Math.max(this.props.currentPage-1,1))}),s.createElement(l.Z.Item,{active:this.props.currentPage<=1,onClick:()=>this.props.selectPage(1)},"1"),p,e,p,this.props.totalPages>=2?s.createElement(l.Z.Item,{active:this.props.currentPage>=this.props.totalPages,onClick:()=>this.props.selectPage(this.props.totalPages)},this.props.totalPages):null,this.props.totalPages>7?s.createElement(o.Z,{show:this.state.showGoto,placement:"top",overlay:g},s.createElement(l.Z.Item,{onClick:()=>this.setState((e=>({showGoto:!e.showGoto})))},s.createElement(r.G,{icon:"search"}))):null,s.createElement(l.Z.Next,{disabled:this.props.currentPage>=this.props.totalPages,onClick:()=>this.props.selectPage(Math.min(this.props.currentPage+1,this.props.totalPages))})))}}},32240:function(e,t,n){n.r(t);var r=n(51436),s=n(67814),a=n(67294),i=n(35005),o=n(32258),l=n(94716),c=n(62318),d=n(15293),m=n(43489),h=n(44012),u=n(9899),p=n(48509),g=n(96846),y=n(53803),w=n(39521),E=n(96190),v=n(27428),f=n(16964),Z=n(1320),P=n(3e3),V=n(9635),b=n(8425),O=n(35855),C=n(89929);function S(){return S=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},S.apply(this,arguments)}class x extends a.Component{constructor(e){super(e);const t={version:"514.1589",engine:p.rG.Byond},n={engine:p.rG.OpenDream,sourceSHA:"fab769776dada6b9bcad546094d78c604049e0e9"};this.state={versions:[],errors:[],latestByondVersion:t,latestODVersion:n,loading:!0,page:Z.Mq.byondlistpage??1}}addError(e){this.setState((t=>{const n=Array.from(t.errors);return n.push(e),{errors:n}}))}async loadVersions(){if((0,f.DB)(this.context.instancePermissionSet,p.pJ.ListInstalled)){const e=await u.Z.listAllVersions(this.context.instance.id,{page:this.state.page});if(e.code===y.G.OK){if(this.state.page>e.payload.totalPages&&0!==e.payload.totalPages)return void this.setState({page:1});this.setState({versions:e.payload.content,maxPage:e.payload.totalPages})}else this.addError(e.error)}if((0,f.DB)(this.context.instancePermissionSet,p.pJ.ReadActive)){const e=await u.Z.getActiveVersion(this.context.instance.id);e.code===y.G.OK?this.setState({activeVersion:e.payload.engineVersion}):this.addError(e.error)}}async switchVersion(e,t){this.setState({loading:!0});const n=await u.Z.switchActive(this.context.instance.id,e,t&&this.state.customFile?await this.state.customFile.arrayBuffer():void 0);n.code===y.G.ERROR?this.addError(n.error):(t&&this.setState({customFile:null}),n.payload.installJob?(w.Z.registerJob(n.payload.installJob,this.context.instance.id),w.Z.registerCallback(n.payload.installJob.id,(()=>{this.loadVersions()}))):await this.loadVersions()),this.setState({loading:!1})}async componentDidUpdate(e,t){t.page!==this.state.page&&(Z.Mq.byondlistpage=this.state.page,await this.loadVersions())}async componentDidMount(){const e=v.Z.getLatestDefaultCommit("OpenDreamProject","OpenDream");fetch("https://secure.byond.com/download/version.txt").then((e=>e.text())).then((e=>e.split("\n"))).then((e=>e[0])).then((e=>{const t={engine:p.rG.Byond,version:e};this.setState({latestByondVersion:t,selectedByondVersion:t,loading:!1})})).catch((e=>{this.addError(new g.ZP(g.jK.APP_FAIL,{jsError:Error(e)})),this.setState({loading:!1})})),await this.loadVersions();const t=await e;if(t.code===y.G.ERROR)return void this.addError(t.error);const n={engine:p.rG.OpenDream,sourceSHA:t.payload};this.setState((e=>({latestODVersion:n,selectedODVersion:this.makeUniqueStringForVersion(e.latestODVersion)==this.makeUniqueStringForVersion(e.selectedODVersion??e.latestODVersion)?n:e.selectedODVersion})))}render(){if(this.state.loading)return a.createElement(O.Z,{text:"loading.byond"});const e=(0,f.DB)(this.context.instancePermissionSet,p.pJ.ListInstalled),t=(0,f.DB)(this.context.instancePermissionSet,p.pJ.ReadActive),n=(0,f.DB)(this.context.instancePermissionSet,p.pJ.InstallOfficialOrChangeActiveByondVersion),o=(0,f.DB)(this.context.instancePermissionSet,p.pJ.InstallOfficialOrChangeActiveOpenDreamVersion),l=(0,f.DB)(this.context.instancePermissionSet,p.pJ.DeleteInstall);return a.createElement("div",{className:"text-center"},a.createElement(b.t,{obj:this.state}),a.createElement("h1",null,a.createElement(h.Z,{id:"view.instance.engine"})),this.state.errors.map(((e,t)=>{if(e)return a.createElement(P.ZP,{key:t,error:e,onClose:()=>this.setState((e=>{const n=Array.from(e.errors);return n[t]=void 0,{errors:n}}))})})),e?a.createElement(a.Fragment,null,t?null:a.createElement(V.Z,{title:"view.instance.engine.current_denied"}),a.createElement("div",null,this.state.versions.map((e=>a.createElement(c.Z,{className:"w-md-25 mb-1 mx-auto d-flex",key:this.makeUniqueStringForVersion(e.engineVersion)},n||t?a.createElement(c.Z.Prepend,null,a.createElement(c.Z.Radio,{name:"byond",id:this.makeUniqueStringForVersion(e.engineVersion),value:x.friendlyVersion(e.engineVersion),disabled:e.engineVersion.engine===p.rG.Byond?!n:e.engineVersion.engine===p.rG.OpenDream&&!o,checked:this.makeUniqueStringForVersion(e.engineVersion)===this.makeUniqueStringForVersion(this.state.activeVersion),onChange:async()=>{await this.switchVersion(e.engineVersion,!1)}})):null,a.createElement("label",{className:"flex-grow-1 m-0",htmlFor:this.makeUniqueStringForVersion(e.engineVersion)},a.createElement(d.Z,{overlay:this.tooltip("view.instance.engine.custom"),show:!!e.engineVersion.customIteration&&void 0},(({ref:t,...n})=>a.createElement(c.Z.Text,S({className:"w-100"},n),x.friendlyVersion(e.engineVersion),e.engineVersion.customIteration?a.createElement("div",{className:"ml-auto",ref:t},a.createElement(s.G,{fixedWidth:!0,icon:"info"})):null)))),this.makeUniqueStringForVersion(e.engineVersion)!==this.makeUniqueStringForVersion(this.state.activeVersion)?a.createElement(c.Z.Append,null,a.createElement(d.Z,{overlay:this.tooltip("generic.no_perm"),show:!l&&void 0},a.createElement(i.Z,{variant:"danger",disabled:!l,onClick:async()=>{this.setState({loading:!0});const t=await u.Z.deleteVersion(this.context.instance.id,e.engineVersion);t.code===y.G.ERROR?this.addError(t.error):(w.Z.registerJob(t.payload,this.context.instance.id),w.Z.registerCallback(t.payload.id,(()=>{this.loadVersions()}))),this.setState({loading:!1})}},a.createElement(s.G,{icon:r.$aW})))):null)))),a.createElement(C.Z,{className:"mt-4",selectPage:e=>this.setState({page:e}),totalPages:this.state.maxPage??1,currentPage:this.state.page})):t?a.createElement(a.Fragment,null,a.createElement(V.Z,{title:"view.instance.engine.list_denied"}),a.createElement(h.Z,{id:"view.instance.engine.current_version",values:{version:this.state.activeVersion}})):a.createElement(V.Z,{title:"view.instance.engine.current_and_list_denied"}),a.createElement("hr",null),this.renderByondInstall(),a.createElement("hr",null),this.renderODInstall())}tooltip(e){return e?a.createElement(m.Z,{id:e},a.createElement(h.Z,{id:e})):a.createElement(a.Fragment,null)}renderByondInstall(){const e=(0,f.DB)(this.context.instancePermissionSet,p.pJ.InstallCustomByondVersion),t=(0,f.DB)(this.context.instancePermissionSet,p.pJ.InstallOfficialOrChangeActiveByondVersion);return a.createElement(a.Fragment,null,a.createElement("h4",null,a.createElement(h.Z,{id:"view.instance.engine.add_byond"})),a.createElement(c.Z,{className:"w-md-50 w-lg-25 mb-3 mx-auto"},a.createElement(l.Z,{type:"number",defaultValue:this.state.latestByondVersion.version.split(".")[0],onChange:e=>{this.setState((t=>{const n=(t.selectedByondVersion??t.latestByondVersion).version.split(".");return n[0]=e.target.value,{selectedByondVersion:{engine:p.rG.Byond,version:n.join(".")}}}))}}),a.createElement(c.Z.Text,{className:"rounded-0"},"."),a.createElement(l.Z,{type:"number",defaultValue:this.state.latestByondVersion.version.split(".")[1],onChange:e=>{this.setState((t=>{const n=(t.selectedByondVersion??t.latestByondVersion).version.split(".");return n[1]=e.target.value,{selectedByondVersion:{engine:p.rG.Byond,version:n.join(".")}}}))}}),a.createElement(c.Z.Append,null,a.createElement(d.Z,{overlay:this.tooltip("generic.no_perm"),show:!t&&void 0},a.createElement(i.Z,{variant:"success",disabled:!t,onClick:async()=>{await this.switchVersion(this.state.selectedByondVersion??this.state.latestByondVersion,!0)}},a.createElement(s.G,{icon:r.r8p}))))),a.createElement(o.Z,null,a.createElement(d.Z,{overlay:this.tooltip("generic.no_perm"),show:!e&&void 0},a.createElement(o.Z.File,{custom:!0,id:"test",disabled:!e,className:"w-md-50 w-lg-25 text-left",label:this.state.customFile?this.state.customFile.name:a.createElement(h.Z,{id:"view.instance.engine.upload"}),accept:".zip",onChange:e=>{this.setState({customFile:e.target.files?e.target.files[0]:null})}}))))}renderODInstall(){const e=(0,f.DB)(this.context.instancePermissionSet,p.pJ.InstallCustomOpenDreamVersion),t=(0,f.DB)(this.context.instancePermissionSet,p.pJ.InstallOfficialOrChangeActiveOpenDreamVersion);return a.createElement(a.Fragment,null,a.createElement("h4",null,a.createElement(h.Z,{id:"view.instance.engine.add_od"})),a.createElement(c.Z,{className:"w-md-50 w-lg-25 mb-3 mx-auto"},a.createElement(l.Z,{type:"string",defaultValue:this.state.latestODVersion.sourceSHA,value:(this.state.selectedODVersion??this.state.latestODVersion).sourceSHA,onChange:e=>{this.setState({selectedODVersion:{engine:p.rG.OpenDream,sourceSHA:e.target.value}})}}),a.createElement(c.Z.Append,null,a.createElement(d.Z,{overlay:this.tooltip("generic.no_perm"),show:!t&&void 0},a.createElement(i.Z,{variant:"success",disabled:!t,onClick:async()=>{await this.switchVersion(this.state.selectedODVersion??this.state.latestODVersion,!0)}},a.createElement(s.G,{icon:r.r8p}))))),a.createElement(o.Z,null,a.createElement(d.Z,{overlay:this.tooltip("generic.no_perm"),show:!e&&void 0},a.createElement(o.Z.File,{custom:!0,id:"test",disabled:!e,className:"w-md-50 w-lg-25 text-left",label:this.state.customFile?this.state.customFile.name:a.createElement(h.Z,{id:"view.instance.engine.upload"}),accept:".zip",onChange:e=>{this.setState({customFile:e.target.files?e.target.files[0]:null})}}))))}makeUniqueStringForVersion(e){return e?`${e.engine}-${e.version??"null"}-${e.sourceSHA??"null"}-${e.customIteration??"null"}`:"null-version"}static friendlyVersion(e){let t;switch(e.engine){case p.rG.Byond:t=e.version,t.endsWith(".0")&&(t=t.substring(0,t.length-2));break;case p.rG.OpenDream:t=`OD-${e.sourceSHA.substring(0,7)}`;break;default:throw new Error(`Unknown engine type: ${e.engine}`)}return e.customIteration?`${t} (${e.customIteration})`:t}}x.contextType=E.g,t.default=x},96190:function(e,t,n){n.d(t,{g:function(){return r}});const r=n(67294).createContext(void 0)},27428:function(e,t,n){var r=n(6964),s=n(17347),a=n(52638),i=n(12527),o=n(96846),l=n(53803),c=n(27961),d=n(86755);async function m(e,t,n){const r=e.endpoint.merge(t,n);return c.ZP.githubtoken.value&&(r.headers.authorization=`token ${c.ZP.githubtoken.value}`),e(r)}async function h(){return c.ZP.githubtoken.value?{type:"token",tokenType:"pat",token:c.ZP.githubtoken.value}:{type:"unauthenticated"}}const u=()=>Object.assign(h.bind(null),{hook:m.bind(null)}),p=new class extends i.TypedEmitter{constructor(){super(),this.apiClient=void 0;const e=a.v.plugin(r.X,s.O);this.apiClient=new e({authStrategy:u,userAgent:"tgstation-server-control-panel/"+d.q4,baseUrl:"https://api.github.com",throttle:{onRateLimit:(e,t)=>(console.warn(`Request quota exhausted for request ${t.method} ${t.url}`),0===t.request.retryCount&&(console.log(`Retrying after ${e} seconds!`),!0)),onAbuseLimit:(e,t)=>{console.warn(`Abuse detected for request ${t.method} ${t.url}`)}}})}async getLatestDefaultCommit(e,t){try{const n=await this.apiClient.repos.get({owner:e,repo:t}),r=await this.apiClient.repos.getBranch({owner:e,repo:t,branch:n.data.default_branch});return new l.Z({code:l.G.OK,payload:r.data.commit.sha})}catch(e){return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}}async getVersions({owner:e,repo:t,current:n,all:r}){let s,a=0;try{s=await this.apiClient.paginate(this.apiClient.repos.listReleases,{owner:e,repo:t},((e,t)=>e.data.reduce(((e,s)=>{const i=/tgstation-server-v([\d.]+)/.exec(s.name??"");if(!i)return e;if(parseInt(i[1][0])<4)return e;const o=i[1];let l=!1;if(o<=n){if(a>=3&&!r)return t(),e;a++,l=!0}return e.push({version:o,body:s.body??"",current:o===n,old:l}),e}),[])))}catch(e){return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new l.Z({code:l.G.OK,payload:s})}transformPR(e){return{number:e.number,title:e.title,author:e.user?.login??"ghost",state:e.merged_at?"merged":e.state,link:e.html_url,head:e.head.sha,tail:e.base.sha,testmergelabel:e.labels.some((e=>e.name?.toLowerCase().includes("testmerge")||e.name?.toLowerCase().includes("test merge")))}}async getPRs({owner:e,repo:t,wantedPRs:n}){let r=[];try{r=(await this.apiClient.paginate(this.apiClient.pulls.list,{owner:e,repo:t,state:"open"})).map(this.transformPR);for(const s of n??[])if(!r.find((e=>e.number==s))){const n=(await this.apiClient.pulls.get({owner:e,repo:t,pull_number:s})).data;r.push(this.transformPR(n))}}catch(e){return console.error(e),new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new l.Z({code:l.G.OK,payload:r})}async getPRCommits({owner:e,repo:t,pr:n,wantedCommit:r}){let s,a=[];try{if(a=await this.apiClient.paginate(this.apiClient.pulls.listCommits,{owner:e,repo:t,pull_number:n.number,per_page:100},(({data:e})=>e.map((e=>({name:e.commit.message.split("\n")[0],sha:e.sha,url:e.html_url}))))),a.reverse(),r&&!a.find((e=>e.sha===r))){const n=(await this.apiClient.repos.getCommit({owner:e,repo:t,ref:r})).data;s={name:n.commit.message.split("\n")[0],sha:n.sha,url:n.html_url}}}catch(e){return console.error(e),new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}return new l.Z({code:l.G.OK,payload:[a,s]})}async getFile(e,t,n,r){try{const{data:s}=await this.apiClient.repos.getContent({mediaType:{format:"base64"},owner:e,repo:t,path:n,ref:r});if(Array.isArray(s))return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${n} was a directory!`)})});if("file"!==s.type)return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${n} has type ${s.type}!`)})});const a=s.content;return new l.Z({code:l.G.OK,payload:a})}catch(e){return console.error(e),new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}}async getDirectoryContents(e,t,n,r){try{const{data:s}=await this.apiClient.repos.getContent({owner:e,repo:t,path:n,ref:r});if(!Array.isArray(s))return new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:new Error(`${n} was not a directory!`)})});const a=[];return s.forEach((e=>a.push({path:e.path,isDirectory:"dir"==e.type}))),new l.Z({code:l.G.OK,payload:a})}catch(e){return console.error(e),new l.Z({code:l.G.ERROR,error:new o.ZP(o.jK.GITHUB_FAIL,{jsError:e})})}}};t.Z=p}}]);
//# sourceMappingURL=240.9d4d9c96f62ce48cce5f.bundle.js.map
"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[345],{7345:function(e,t,s){s.r(t);var r=s(7814),n=s(7294),i=s(8375),a=s(5509),o=s(6841),c=s(1555),m=s(2318),l=s(2258),d=s(5005),u=s(5293),h=s(3489),p=s(4012),g=s(5977),E=s(8509),P=s(6352),S=s(5870),f=s(6846),Z=s(3803),y=s(6942),b=s(4803),x=s(6190),w=s(6964),v=s(1320),k=s(3e3),R=s(9049),C=s(8425),I=s(5855);function $(){return $=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},$.apply(this,arguments)}class N extends n.Component{constructor(e){super(e),this.loadCurrentPermissions=this.loadCurrentPermissions.bind(this),this.createPermissionSetForCurrent=this.createPermissionSetForCurrent.bind(this),this.grantPermissions=this.grantPermissions.bind(this),this.state={errors:[],loading:!0,loadingPerms:!0,instanceNeedsReload:!1,tab:"instancepermissionsetperms",userPermissions:{permissionSetId:0,instancePermissionSetRights:0,repositoryRights:0,byondRights:0,dreamMakerRights:0,dreamDaemonRights:0,chatBotRights:0,configurationRights:0},currentPermissions:null,selectedPermissionSetId:0,permsinstancepermissionset:{},permsrepository:{},permsbyond:{},permsdreammaker:{},permsdreamdaemon:{},permschatbots:{},permsconfiguration:{}}}loadEnums(e){this.setState({currentPermissions:e});const t=(t,s,r)=>{Object.entries(t).forEach((([t,n])=>{if(!isNaN(parseInt(t)))return;const i=t.toLowerCase(),a=n;if("none"==i)return;const o=!!(e[s]&a);this.setState((e=>({[r]:{...e[r],[i]:{currentVal:o,bitflag:a}}})))}))};t(E.d$,"instancePermissionSetRights","permsinstancepermissionset"),t(E.nX,"repositoryRights","permsrepository"),t(E.D8,"byondRights","permsbyond"),t(E.xb,"dreamMakerRights","permsdreammaker"),t(E.py,"dreamDaemonRights","permsdreamdaemon"),t(E.xr,"chatBotRights","permschatbots"),t(E.TI,"configurationRights","permsconfiguration")}addError(e){this.setState((t=>{const s=Array.from(t.errors);return s.push(e),{errors:s}}))}async loadCurrentPermissions(e){if(this.setState({loadingPerms:!0}),e===(0,w.Zg)(this.context.user).id){const e=new Promise((e=>setTimeout(e,200))),t=await S.Z.getCurrentInstancePermissionSet(this.context.instance.id,!0);await e,t.code===Z.G.OK?(this.setState({userPermissions:t.payload}),this.loadEnums(t.payload)):this.addError(t.error)}else if((0,w.JY)(this.context.instancePermissionSet,E.d$.Read)){const t=await S.Z.getByPermissionSetId(this.context.instance.id,e);t.code===Z.G.OK?this.loadEnums(t.payload):t.error.code==f.jK.NO_DB_ENTITY?this.setState({currentPermissions:null}):this.addError(t.error)}this.setState({loadingPerms:!1})}async loadUsersAndGroups(){const e=(0,w.Zg)(this.context.user);if(!(0,w.N3)(e,E.oj.ReadUsers))return void this.setState({groups:null,users:null});let t=!1;const s=y.Z.listUsers({page:1,pageSize:100}),r=await b.Z.listGroups({page:1,pageSize:100});t=!0,r.code===Z.G.OK?this.setState({groups:r.payload.content}):(this.addError(r.error),t=!1);const n=await s;n.code===Z.G.OK?this.setState({users:n.payload.content.filter((e=>!e.group))}):(this.addError(n.error),t=!1),t||(this.context.user.group?this.setState({groups:[this.context.user.group],users:[]}):this.setState({groups:[],users:[this.context.user]}))}async loadAllPermissionSets(){let e=!1;if((0,w.JY)(this.context.instancePermissionSet,E.d$.Read)){const t=await S.Z.listInstancePermissionSets(this.context.instance.id,{page:1,pageSize:100});t.code===Z.G.OK?(this.setState({instancePermissionSets:t.payload.content}),e=!0):this.addError(t.error)}e||this.setState({instancePermissionSets:[this.context.instancePermissionSet]})}async createPermissionSetForCurrent(){const e=await S.Z.createInstancePermissionSet(this.context.instance.id,{permissionSetId:this.state.selectedPermissionSetId});e.code!=Z.G.OK?this.addError(e.error):this.setState({currentPermissions:e.payload})}async grantPermissions(){const e=await P.Z.grantPermissions({id:this.context.instance.id});e.code!=Z.G.OK?this.addError(e.error):await this.loadCurrentPermissions(this.state.selectedPermissionSetId)}async deletePermissionSet(){if(!confirm("Are you sure you want to delete this permission set? The selected user/group will lose access to the instance."))return;const e=await S.Z.deleteInstancePermissionSet(this.context.instance.id,this.state.selectedPermissionSetId);e.code!=Z.G.OK&&e.error.code!=f.jK.NO_DB_ENTITY?this.addError(e.error):this.state.selectedPermissionSetId===(0,w.Zg)(this.context.user).id?(v.Mq.selectedinstanceid=void 0,this.props.history.push(v.$w.instancelist.link??v.$w.instancelist.route)):this.setState({currentPermissions:null})}async componentDidMount(){const e=(0,w.Zg)(this.context.user).id;this.setState({selectedPermissionSetId:e,userPermissions:this.context.instancePermissionSet});const t=this.loadCurrentPermissions(e),s=this.loadAllPermissionSets();await this.loadUsersAndGroups(),await t,await s,this.setState({loading:!1})}async componentWillUnmount(){this.state.instanceNeedsReload&&await this.context.reloadInstance()}render(){if(this.state.loading)return n.createElement(I.Z,{text:"loading.instance.perms"});const e=new Map,t={};if(this.state.users&&this.state.groups)this.state.users?.forEach((s=>{const r=`User: ${s.name}${s.id===this.context.user.id?" (You)":""}`;e.set(r,s.permissionSet.id),t[r]=s.permissionSet.id})),this.state.groups?.forEach((s=>{const r=`Group: ${s.name}${s.id===this.context.user.group?.id?" (Your Group)":""}`;e.set(r,s.permissionSet.id),t[r]=s.permissionSet.id}));else{if(this.context.user.group){const s=`Group: ${this.context.user.group.name} (Your Group)`;e.set(s,this.context.user.group.permissionSet.id),t[s]=this.context.user.group.permissionSet.id}else{const s=`User: ${this.context.user.name} (You)`;e.set(s,this.context.user.permissionSet.id),t[s]=this.context.user.permissionSet.id}this.state.instancePermissionSets?.forEach((s=>{if(s.permissionSetId===(0,w.Zg)(this.context.user).id)return;const r=`Permission Set ${s.permissionSetId}`;e.set(r,s.permissionSetId),t[r]=s.permissionSetId}))}return n.createElement("div",{className:"text-center"},n.createElement("h1",null,n.createElement(p.Z,{id:"view.instance.perms"})),n.createElement(C.t,{obj:this.state}),this.state.errors.map(((e,t)=>{if(e)return n.createElement(k.ZP,{key:t,error:e,onClose:()=>this.setState((e=>{const s=Array.from(e.errors);return s[t]=void 0,{errors:s}}))})})),n.createElement(R.ZP,{name:"fields.instance.perms.owner",type:R.fS.Enum,enum:t,noLocalize:!0,defaultValue:this.state.selectedPermissionSetId,disabled:this.context.instancePermissionSet.instancePermissionSetRights===E.d$.None,onChange:e=>{this.setState({selectedPermissionSetId:e}),this.loadCurrentPermissions(e)}}),n.createElement("hr",null),this.renderPermissionEditor())}renderPermissionEditor(){if(this.state.loadingPerms)return n.createElement(I.Z,{text:"loading.perms"});let e=!1,t=n.createElement(n.Fragment,null);const s=(0,w.Zg)(this.context.user);if(s.id!==this.state.selectedPermissionSetId||!(0,w.D0)(s,E.c2.GrantPermissions)||this.state.currentPermissions&&(0,w.JY)(this.state.currentPermissions,E.d$.Write)||(e=!0,t=n.createElement(n.Fragment,null,n.createElement("hr",null),n.createElement("h5",null,n.createElement(p.Z,{id:"view.instance.perms.grant.desc"})),n.createElement(d.Z,{variant:"success",onClick:()=>{this.grantPermissions()}},n.createElement(p.Z,{id:"view.instance.perms.grant"})))),!this.state.currentPermissions){const t=(0,w.JY)(this.state.userPermissions,E.d$.Create);return n.createElement("div",{className:"text-center mt-2"},n.createElement("h3",null,n.createElement(p.Z,{id:"view.instance.perms.missing"})),e?n.createElement(n.Fragment,null):n.createElement(n.Fragment,null,n.createElement("br",null),n.createElement(u.Z,{placement:"top",overlay:e=>n.createElement(h.Z,$({id:"create-ips-tooltop"},e),n.createElement(p.Z,{id:"view.instance.perms.create"}))},n.createElement(d.Z,{variant:"success",disabled:!t,onClick:()=>{this.createPermissionSetForCurrent()}},n.createElement(p.Z,{id:"view.instance.perms.create"})))))}return n.createElement(n.Fragment,null,this.renderEditorTabs(),t)}renderEditorTabs(){const e=(0,w.JY)(this.state.userPermissions,E.d$.Write);return n.createElement(n.Fragment,null,e?n.createElement(n.Fragment,null):n.createElement(i.Z,{className:"clearfix",variant:"error"},n.createElement(p.Z,{id:"perms.instancepermissionset.cantedit"})),n.createElement(a.Z,{activeKey:this.state.tab,onSelect:e=>{e&&this.setState({tab:e})},id:"permission-tabs",className:"justify-content-center mb-3 mt-4 flex-column flex-md-row"},n.createElement(o.Z,{eventKey:"instancepermissionsetperms",title:n.createElement(p.Z,{id:"perms.instancepermissionset"})},this.renderPerms("permsinstancepermissionset","instancepermissionset",e)),n.createElement(o.Z,{eventKey:"repositoryperms",title:n.createElement(p.Z,{id:"perms.repository"})},this.renderPerms("permsrepository","repository",e)),n.createElement(o.Z,{eventKey:"byondperms",title:n.createElement(p.Z,{id:"perms.byond"})},this.renderPerms("permsbyond","byond",e)),n.createElement(o.Z,{eventKey:"dreammakerperms",title:n.createElement(p.Z,{id:"perms.dreammaker"})},this.renderPerms("permsdreammaker","dreammaker",e)),n.createElement(o.Z,{eventKey:"dreamdaemonperms",title:n.createElement(p.Z,{id:"perms.dreamdaemon"})},this.renderPerms("permsdreamdaemon","dreamdaemon",e)),n.createElement(o.Z,{eventKey:"chatbotsperms",title:n.createElement(p.Z,{id:"perms.chatbots"})},this.renderPerms("permschatbots","chatbots",e)),n.createElement(o.Z,{eventKey:"configurationperms",title:n.createElement(p.Z,{id:"perms.configuration"})},this.renderPerms("permsconfiguration","configuration",e))),"instancepermissionsetperms"===this.state.tab&&e?n.createElement(n.Fragment,null,n.createElement("br",null),n.createElement(d.Z,{variant:"danger",onClick:()=>{this.deletePermissionSet()}},n.createElement(p.Z,{id:"view.instance.perms.delete"}))):n.createElement(n.Fragment,null))}renderPerms(e,t,s){const i={},a=(e,t,s)=>{e.current&&t.current&&(e.current.checked!==s?t.current.classList.add("font-weight-bold"):t.current.classList.remove("font-weight-bold"))},o=t=>()=>{for(const[s,r]of Object.entries(i)){if(!r.input.current)return;r.input.current.checked=t,a(r.input,r.field,this.state[e][s].currentVal)}};return n.createElement(n.Fragment,null,s?n.createElement(n.Fragment,null,n.createElement("h5",null,n.createElement(p.Z,{id:"generic.setall"})),n.createElement(d.Z,{onClick:o(!0)},n.createElement(p.Z,{id:"generic.true"}))," ",n.createElement(d.Z,{onClick:o(!1)},n.createElement(p.Z,{id:"generic.false"}))," ",n.createElement(d.Z,{onClick:()=>{for(const[t,s]of Object.entries(i))s.input.current&&(s.input.current.checked=this.state[e][t].currentVal,a(s.input,s.field,this.state[e][t].currentVal))}},n.createElement(p.Z,{id:"generic.reset"}))):"",n.createElement(c.Z,{md:8,lg:7,xl:6,className:"mx-auto"},n.createElement("hr",null),Object.entries(this.state[e]).map((([o,c])=>{const d=n.createRef(),g=n.createRef();return i[o]={input:d,field:g},n.createElement(m.Z,{key:`${e}.${o}`,as:"label",htmlFor:o,className:"mb-0"},n.createElement(m.Z.Prepend,{className:"flex-grow-1 overflow-auto"},n.createElement(u.Z,{overlay:n.createElement(h.Z,{id:`perms.${t}.${o}.desc`},n.createElement(p.Z,{id:`perms.${t}.${o}.desc`}))},(({ref:i,...u})=>n.createElement(m.Z.Text,{className:"flex-fill",ref:g},n.createElement("div",u,n.createElement(p.Z,{id:`perms.${t}.${o}`})),n.createElement("div",{className:"ml-auto d-flex align-items-center"},n.createElement(l.Z.Check,{inline:!0,type:"switch",custom:!0,id:`${e}.${o}`,className:"d-flex justify-content-center align-content-center mx-2",label:"",ref:d,disabled:!s,defaultChecked:c.currentVal,onChange:()=>{a(d,g,c.currentVal)}}),n.createElement("div",$({},u,{ref:i}),n.createElement(r.G,{fixedWidth:!0,icon:"info"}))))))))})),n.createElement("hr",null)),s?n.createElement(d.Z,{onClick:async()=>{this.setState({loadingPerms:!0});let t,s=0;for(const[t,r]of Object.entries(i))r.input.current&&(s+=r.input.current.checked?this.state[e][t].bitflag:0);if(!this.state.currentPermissions)return void this.addError(new f.ZP(f.jK.APP_FAIL,{jsError:Error("this.state.user is null in user edit save")}));switch(e){case"permsinstancepermissionset":t="InstancePermissionSetRights";break;case"permsrepository":t="RepositoryRights";break;case"permsbyond":t="ByondRights";break;case"permsdreammaker":t="DreamMakerRights";break;case"permsdreamdaemon":t="DreamDaemonRights";break;case"permschatbots":t="ChatBotRights";break;case"permsconfiguration":t="ConfigurationRights"}const r=Object.assign(Object.assign({},this.state.currentPermissions),{[t]:s}),n=await S.Z.updateInstancePermissionSet(this.context.instance.id,r);n.code==Z.G.OK?(r.permissionSetId===this.state.userPermissions?.permissionSetId&&this.setState({userPermissions:n.payload,instanceNeedsReload:!0}),this.loadEnums(n.payload)):this.addError(n.error),this.setState({loadingPerms:!1})}},n.createElement(p.Z,{id:"generic.savetab"})):"")}}N.contextType=x.g,t.default=(0,g.EN)(N)}}]);
//# sourceMappingURL=345.fb67a1ab5808fd67a63e.bundle.js.map
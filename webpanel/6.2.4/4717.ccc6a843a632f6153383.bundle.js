"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[4717],{6795:function(e,t,n){n.d(t,{Q:function(){return l}});var s=n(6540),r=n(8785),a=n.n(r),i=n(8437);function o(e){return s.createElement(a(),{src:e.obj,name:"JSON",theme:"tube",iconStyle:"triangle",collapsed:!0,displayDataTypes:!1})}function l(e){return i.Ay.showjson.value?s.createElement("div",{className:"text-left"},s.createElement(o,{obj:e.obj})):s.createElement(s.Fragment,null)}},5282:function(e,t,n){n.d(t,{A:function(){return u}});var s=n(6784),r=n(6540),a=n(5615),i=n(1208),o=n(5038),l=n(1069),c=n(3899),d=n(8065);function m(){return m=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)({}).hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},m.apply(null,arguments)}class u extends r.PureComponent{constructor(e){super(e),this.state={showGoto:!1,gotoValue:e.currentPage}}render(){const e=[],t=Math.max(this.props.totalPages-this.props.currentPage-1,0),n=Math.max(this.props.currentPage-2,0),u=Math.max(this.props.currentPage-Math.max(5-Number(this.props.currentPage!==this.props.totalPages)-t,2),2),p=Math.min(this.props.currentPage+Math.max(5-Number(1!==this.props.currentPage)-n,2),this.props.totalPages-1);for(let t=u;t<=p;t++)e.push(r.createElement(l.A.Item,{key:t,active:t===this.props.currentPage,onClick:()=>this.props.selectPage(t)},t));const h=this.props.totalPages>7?r.createElement(l.A.Ellipsis,{disabled:!0}):null,g=r.createElement(c.A,{id:"popover-gotopage"},r.createElement(c.A.Title,null,r.createElement(d.A,{id:"generic.goto.title"})),r.createElement(c.A.Content,null,r.createElement("form",{className:"d-flex",onSubmit:e=>{e.preventDefault(),this.props.selectPage(this.state.gotoValue),this.setState({showGoto:!1})}},r.createElement(i.A.Control,{className:"mr-2",type:"number",min:1,max:this.props.totalPages,value:this.state.gotoValue,onChange:e=>this.setState({gotoValue:parseInt(e.target.value)}),custom:!0}),r.createElement(a.A,{type:"submit"},r.createElement(d.A,{id:"generic.goto"}))))),{selectPage:y,totalPages:A,currentPage:E,...w}=this.props;return r.createElement("div",m({className:"text-center",style:{position:"sticky",bottom:"1.5em"}},w),r.createElement(l.A,{className:"justify-content-center"},r.createElement(l.A.Prev,{disabled:this.props.currentPage<=1,onClick:()=>this.props.selectPage(Math.max(this.props.currentPage-1,1))}),r.createElement(l.A.Item,{active:this.props.currentPage<=1,onClick:()=>this.props.selectPage(1)},"1"),h,e,h,this.props.totalPages>=2?r.createElement(l.A.Item,{active:this.props.currentPage>=this.props.totalPages,onClick:()=>this.props.selectPage(this.props.totalPages)},this.props.totalPages):null,this.props.totalPages>7?r.createElement(o.A,{show:this.state.showGoto,placement:"top",overlay:g},r.createElement(l.A.Item,{onClick:()=>this.setState((e=>({showGoto:!e.showGoto})))},r.createElement(s.g,{icon:"search"}))):null,r.createElement(l.A.Next,{disabled:this.props.currentPage>=this.props.totalPages,onClick:()=>this.props.selectPage(Math.min(this.props.currentPage+1,this.props.totalPages))})))}}},4717:function(e,t,n){n.r(t);var s=n(6188),r=n(6784),a=n(6540),i=n(5615),o=n(1208),l=n(1364),c=n(5192),d=n(5038),m=n(3524),u=n(8065),p=n(9013),h=n(2576),g=n(4173),y=n(5301),A=n(379),E=n(7621),w=n(3782),v=n(4118),f=n(664),V=n(7567),b=n(5659),O=n(6795),P=n(7255),C=n(5282);function S(){return S=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var s in n)({}).hasOwnProperty.call(n,s)&&(e[s]=n[s])}return e},S.apply(null,arguments)}class x extends a.Component{constructor(e){super(e);const t={version:"514.1589",engine:h.p3.Byond},n={engine:h.p3.OpenDream,sourceSHA:"fab769776dada6b9bcad546094d78c604049e0e9"};this.state={versions:[],errors:[],latestByondVersion:t,latestODVersion:n,loading:!0,page:f.M2.byondlistpage??1}}addError(e){this.setState((t=>{const n=Array.from(t.errors);return n.push(e),{errors:n}}))}async loadVersions(){if((0,v.Dp)(this.context.instancePermissionSet,h.em.ListInstalled)){const e=await p.A.listAllVersions(this.context.instance.id,{page:this.state.page});if(e.code===y.s.OK){if(this.state.page>e.payload.totalPages&&0!==e.payload.totalPages)return void this.setState({page:1});this.setState({versions:e.payload.content,maxPage:e.payload.totalPages})}else this.addError(e.error)}if((0,v.Dp)(this.context.instancePermissionSet,h.em.ReadActive)){const e=await p.A.getActiveVersion(this.context.instance.id);e.code===y.s.OK?this.setState({activeVersion:e.payload.engineVersion}):this.addError(e.error)}}async switchVersion(e,t){this.setState({loading:!0});const n=await p.A.switchActive(this.context.instance.id,e,t&&this.state.customFile?await this.state.customFile.arrayBuffer():void 0);n.code===y.s.ERROR?this.addError(n.error):(t&&this.setState({customFile:null}),n.payload.installJob?(A.default.registerJob(n.payload.installJob,this.context.instance.id),A.default.registerCallback(n.payload.installJob.id,(()=>{this.loadVersions()}))):await this.loadVersions()),this.setState({loading:!1})}async componentDidUpdate(e,t){t.page!==this.state.page&&(f.M2.byondlistpage=this.state.page,await this.loadVersions())}async componentDidMount(){const e=w.A.getLatestDefaultCommit("OpenDreamProject","OpenDream");fetch("https://secure.byond.com/download/version.txt").then((e=>e.text())).then((e=>e.split("\n"))).then((e=>e[0])).then((e=>{const t={engine:h.p3.Byond,version:e};this.setState({latestByondVersion:t,selectedByondVersion:t,loading:!1})})).catch((e=>{this.addError(new g.Ay(g.O4.APP_FAIL,{jsError:Error(e)})),this.setState({loading:!1})})),await this.loadVersions();const t=await e;if(t.code===y.s.ERROR)return void this.addError(t.error);const n={engine:h.p3.OpenDream,sourceSHA:t.payload};this.setState((e=>({latestODVersion:n,selectedODVersion:this.makeUniqueStringForVersion(e.latestODVersion)==this.makeUniqueStringForVersion(e.selectedODVersion??e.latestODVersion)?n:e.selectedODVersion})))}render(){if(this.state.loading)return a.createElement(P.default,{text:"loading.byond"});const e=(0,v.Dp)(this.context.instancePermissionSet,h.em.ListInstalled),t=(0,v.Dp)(this.context.instancePermissionSet,h.em.ReadActive),n=(0,v.Dp)(this.context.instancePermissionSet,h.em.InstallOfficialOrChangeActiveByondVersion),o=(0,v.Dp)(this.context.instancePermissionSet,h.em.InstallOfficialOrChangeActiveOpenDreamVersion),l=(0,v.Dp)(this.context.instancePermissionSet,h.em.DeleteInstall);return a.createElement("div",{className:"text-center"},a.createElement(O.Q,{obj:this.state}),a.createElement("h1",null,a.createElement(u.A,{id:"view.instance.engine"})),this.state.errors.map(((e,t)=>{if(e)return a.createElement(V.Ay,{key:t,error:e,onClose:()=>this.setState((e=>{const n=Array.from(e.errors);return n[t]=void 0,{errors:n}}))})})),e?a.createElement(a.Fragment,null,t?null:a.createElement(b.A,{title:"view.instance.engine.current_denied"}),a.createElement("div",null,this.state.versions.map((e=>a.createElement(c.A,{className:"w-md-25 mb-1 mx-auto d-flex",key:this.makeUniqueStringForVersion(e.engineVersion)},n||t?a.createElement(c.A.Prepend,null,a.createElement(c.A.Radio,{name:"byond",id:this.makeUniqueStringForVersion(e.engineVersion),value:x.friendlyVersion(e.engineVersion),disabled:e.engineVersion.engine===h.p3.Byond?!n:e.engineVersion.engine===h.p3.OpenDream&&!o,checked:this.makeUniqueStringForVersion(e.engineVersion)===this.makeUniqueStringForVersion(this.state.activeVersion),onChange:async()=>{await this.switchVersion(e.engineVersion,!1)}})):null,a.createElement("label",{className:"flex-grow-1 m-0",htmlFor:this.makeUniqueStringForVersion(e.engineVersion)},a.createElement(d.A,{overlay:this.tooltip("view.instance.engine.custom"),show:!!e.engineVersion.customIteration&&void 0},(({ref:t,...n})=>a.createElement(c.A.Text,S({className:"w-100"},n),x.friendlyVersion(e.engineVersion),e.engineVersion.customIteration?a.createElement("div",{className:"ml-auto",ref:t},a.createElement(r.g,{fixedWidth:!0,icon:"info"})):null)))),this.makeUniqueStringForVersion(e.engineVersion)!==this.makeUniqueStringForVersion(this.state.activeVersion)?a.createElement(c.A.Append,null,a.createElement(d.A,{overlay:this.tooltip("generic.no_perm"),show:!l&&void 0},a.createElement(i.A,{variant:"danger",disabled:!l,onClick:()=>{(async()=>{this.setState({loading:!0});const t=await p.A.deleteVersion(this.context.instance.id,e.engineVersion);t.code===y.s.ERROR?this.addError(t.error):(A.default.registerJob(t.payload,this.context.instance.id),A.default.registerCallback(t.payload.id,(()=>{this.loadVersions()}))),this.setState({loading:!1})})()}},a.createElement(r.g,{icon:s.yLS})))):null)))),a.createElement(C.A,{className:"mt-4",selectPage:e=>this.setState({page:e}),totalPages:this.state.maxPage??1,currentPage:this.state.page})):t?a.createElement(a.Fragment,null,a.createElement(b.A,{title:"view.instance.engine.list_denied"}),a.createElement(u.A,{id:"view.instance.engine.current_version",values:{version:this.state.activeVersion}})):a.createElement(b.A,{title:"view.instance.engine.current_and_list_denied"}),a.createElement("hr",null),this.renderByondInstall(),a.createElement("hr",null),this.renderODInstall())}tooltip(e){return e?a.createElement(m.A,{id:e},a.createElement(u.A,{id:e})):a.createElement(a.Fragment,null)}renderByondInstall(){const e=(0,v.Dp)(this.context.instancePermissionSet,h.em.InstallCustomByondVersion),t=(0,v.Dp)(this.context.instancePermissionSet,h.em.InstallOfficialOrChangeActiveByondVersion);return a.createElement(a.Fragment,null,a.createElement("h4",null,a.createElement(u.A,{id:"view.instance.engine.add_byond"})),a.createElement(c.A,{className:"w-md-50 w-lg-25 mb-3 mx-auto"},a.createElement(l.A,{type:"number",defaultValue:this.state.latestByondVersion.version.split(".")[0],onChange:e=>{this.setState((t=>{const n=(t.selectedByondVersion??t.latestByondVersion).version.split(".");return n[0]=e.target.value,{selectedByondVersion:{engine:h.p3.Byond,version:n.join(".")}}}))}}),a.createElement(c.A.Text,{className:"rounded-0"},"."),a.createElement(l.A,{type:"number",defaultValue:this.state.latestByondVersion.version.split(".")[1],onChange:e=>{this.setState((t=>{const n=(t.selectedByondVersion??t.latestByondVersion).version.split(".");return n[1]=e.target.value,{selectedByondVersion:{engine:h.p3.Byond,version:n.join(".")}}}))}}),a.createElement(c.A.Append,null,a.createElement(d.A,{overlay:this.tooltip("generic.no_perm"),show:!t&&void 0},a.createElement(i.A,{variant:"success",disabled:!t,onClick:()=>{(async()=>{await this.switchVersion(this.state.selectedByondVersion??this.state.latestByondVersion,!0)})()}},a.createElement(r.g,{icon:s.QLR}))))),a.createElement(o.A,null,a.createElement(d.A,{overlay:this.tooltip("generic.no_perm"),show:!e&&void 0},a.createElement(o.A.File,{custom:!0,id:"test",disabled:!e,className:"w-md-50 w-lg-25 text-left",label:this.state.customFile?this.state.customFile.name:a.createElement(u.A,{id:"view.instance.engine.upload"}),accept:".zip",onChange:e=>{this.setState({customFile:e.target.files?e.target.files[0]:null})}}))))}renderODInstall(){const e=(0,v.Dp)(this.context.instancePermissionSet,h.em.InstallCustomOpenDreamVersion),t=(0,v.Dp)(this.context.instancePermissionSet,h.em.InstallOfficialOrChangeActiveOpenDreamVersion);return a.createElement(a.Fragment,null,a.createElement("h4",null,a.createElement(u.A,{id:"view.instance.engine.add_od"})),a.createElement(c.A,{className:"w-md-50 w-lg-25 mb-3 mx-auto"},a.createElement(l.A,{type:"string",defaultValue:this.state.latestODVersion.sourceSHA,value:(this.state.selectedODVersion??this.state.latestODVersion).sourceSHA,onChange:e=>{this.setState({selectedODVersion:{engine:h.p3.OpenDream,sourceSHA:e.target.value}})}}),a.createElement(c.A.Append,null,a.createElement(d.A,{overlay:this.tooltip("generic.no_perm"),show:!t&&void 0},a.createElement(i.A,{variant:"success",disabled:!t,onClick:()=>{(async()=>{await this.switchVersion(this.state.selectedODVersion??this.state.latestODVersion,!0)})()}},a.createElement(r.g,{icon:s.QLR}))))),a.createElement(o.A,null,a.createElement(d.A,{overlay:this.tooltip("generic.no_perm"),show:!e&&void 0},a.createElement(o.A.File,{custom:!0,id:"test",disabled:!e,className:"w-md-50 w-lg-25 text-left",label:this.state.customFile?this.state.customFile.name:a.createElement(u.A,{id:"view.instance.engine.upload"}),accept:".zip",onChange:e=>{this.setState({customFile:e.target.files?e.target.files[0]:null})}}))))}makeUniqueStringForVersion(e){return e?`${e.engine}-${e.version??"null"}-${e.sourceSHA??"null"}-${e.customIteration??"null"}`:"null-version"}static friendlyVersion(e){let t;switch(e.engine){case h.p3.Byond:t=e.version,t.endsWith(".0")&&(t=t.substring(0,t.length-2));break;case h.p3.OpenDream:t=`OD-${e.sourceSHA.substring(0,7)}`;break;default:throw new Error(`Unknown engine type: ${e.engine}`)}return e.customIteration?`${t} (${e.customIteration})`:t}}x.contextType=E.z,t.default=x},7621:function(e,t,n){n.d(t,{z:function(){return s}});const s=n(6540).createContext(void 0)},3782:function(e,t,n){var s=n(9346),r=n(8763),a=n(9757),i=n(4101),o=n(4173),l=n(5301),c=n(8437),d=n(7602);async function m(e,t,n){const s=e.endpoint.merge(t,n);return c.Ay.githubtoken.value&&(s.headers.authorization=`token ${c.Ay.githubtoken.value}`),e(s)}async function u(){return c.Ay.githubtoken.value?{type:"token",tokenType:"pat",token:c.Ay.githubtoken.value}:{type:"unauthenticated"}}const p=()=>Object.assign(u.bind(null),{hook:m.bind(null)}),h=new class extends i.TypedEmitter{constructor(){super(),this.apiClient=void 0;const e=a.E.plugin(s.L,r.A);this.apiClient=new e({authStrategy:p,userAgent:"tgstation-server-control-panel/"+d.xv,baseUrl:"https://api.github.com",throttle:{onRateLimit:(e,t)=>(console.warn(`Request quota exhausted for request ${t.method} ${t.url}`),0===t.request.retryCount&&(console.log(`Retrying after ${e} seconds!`),!0)),onSecondaryRateLimit:(e,t)=>{console.warn(`Abuse detected for request ${t.method} ${t.url}`)}}})}async getLatestDefaultCommit(e,t){try{const n=await this.apiClient.repos.get({owner:e,repo:t}),s=await this.apiClient.repos.getBranch({owner:e,repo:t,branch:n.data.default_branch});return new l.A({code:l.s.OK,payload:s.data.commit.sha})}catch(e){return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}}async getVersions({owner:e,repo:t,current:n,all:s}){let r,a=0;try{r=await this.apiClient.paginate(this.apiClient.repos.listReleases,{owner:e,repo:t},((e,t)=>e.data.reduce(((e,r)=>{const i=/tgstation-server-v([\d.]+)/.exec(r.name??"");if(!i)return e;if(parseInt(i[1][0])<4)return e;const o=i[1];let l=!1;if(o<=n){if(a>=3&&!s)return t(),e;a++,l=!0}return e.push({version:o,body:r.body??"",current:o===n,old:l}),e}),[])))}catch(e){return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}return new l.A({code:l.s.OK,payload:r})}transformPR(e){return{number:e.number,title:e.title,author:e.user?.login??"ghost",state:e.merged_at?"merged":e.state,link:e.html_url,head:e.head.sha,tail:e.base.sha,testmergelabel:e.labels.some((e=>e.name?.toLowerCase().includes("testmerge")||e.name?.toLowerCase().includes("test merge")))}}async getPRs({owner:e,repo:t,wantedPRs:n}){let s=[];try{s=(await this.apiClient.paginate(this.apiClient.pulls.list,{owner:e,repo:t,state:"open"})).map(this.transformPR);for(const r of n??[])if(!s.find((e=>e.number==r))){const n=(await this.apiClient.pulls.get({owner:e,repo:t,pull_number:r})).data;s.push(this.transformPR(n))}}catch(e){return console.error(e),new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}return new l.A({code:l.s.OK,payload:s})}async getPRCommits({owner:e,repo:t,pr:n,wantedCommit:s}){let r,a=[];try{if(a=await this.apiClient.paginate(this.apiClient.pulls.listCommits,{owner:e,repo:t,pull_number:n.number,per_page:100},(({data:e})=>e.map((e=>({name:e.commit.message.split("\n")[0],sha:e.sha,url:e.html_url}))))),a.reverse(),s&&!a.find((e=>e.sha===s))){const n=(await this.apiClient.repos.getCommit({owner:e,repo:t,ref:s})).data;r={name:n.commit.message.split("\n")[0],sha:n.sha,url:n.html_url}}}catch(e){return console.error(e),new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}return new l.A({code:l.s.OK,payload:[a,r]})}async getFile(e,t,n,s){try{const{data:r}=await this.apiClient.repos.getContent({mediaType:{format:"base64"},owner:e,repo:t,path:n,ref:s});if(Array.isArray(r))return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:new Error(`${n} was a directory!`)})});if("file"!==r.type)return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:new Error(`${n} has type ${r.type}!`)})});const a=r.content;return new l.A({code:l.s.OK,payload:a})}catch(e){return console.error(e),new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}}async getDirectoryContents(e,t,n,s){try{const{data:r}=await this.apiClient.repos.getContent({owner:e,repo:t,path:n,ref:s});if(!Array.isArray(r))return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:new Error(`${n} was not a directory!`)})});const a=[];return r.forEach((e=>a.push({path:e.path,isDirectory:"dir"==e.type}))),new l.A({code:l.s.OK,payload:a})}catch(e){return console.error(e),new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}}};t.A=h}}]);
//# sourceMappingURL=4717.ccc6a843a632f6153383.bundle.js.map
"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[3649],{1512:function(e,t,a){a.d(t,{A:function(){return l}});var n=a(6540),r=a(5038),s=a(3524),i=a(8065);function l(e){return n.createElement(r.A,{show:e.show,overlay:n.createElement(s.A,{id:e.tooltipid},n.createElement(i.A,{id:e.tooltipid}))},e.children)}},3649:function(e,t,a){a.r(t),a.d(t,{default:function(){return X}});var n=a(6540),r=a(5615),s=a(1274),i=a(472),l=a(616),o=a(5038),c=a(3524),d=a(2431),m=a(8065),u=a(1930),p=a(2576),h=a(4295),E=a(4173),g=a(5301),f=a(8143),y=a(8437),b=a(379),v=a(7621),A=a(3782),w=a(4118),S=a(7567),C=a(5659),P=a(1723),R=a(6113),T=a(6795),x=a(7255),k=a(1512),M=a(6784),N=a(8280),U=a(6052),I=a(9944),H=a(8854);function O(){return O=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},O.apply(null,arguments)}function D({pr:e,testmergeinfo:t,repoInfo:a,finalState:i,onRemove:l,onSelectCommit:o,onError:c}){const[d,u]=(0,n.useState)(!1),h=e=>{u((t=>{let a;return a="boolean"==typeof e?e:e(t),a&&Q(),a}))},[E,f]=(0,n.useState)(!1),[y,b]=(0,n.useState)(e.head),[S,C]=(0,n.useState)(i?i[1]:""),[R,T]=(0,n.useState)(null),[D,W]=(0,n.useState)(null),B=(0,n.useContext)(v.z),Q=(0,n.useCallback)((async n=>{if(R&&!n)return;const r=await A.A.getPRCommits({owner:a.remoteRepositoryOwner,repo:a.remoteRepositoryName,pr:e,wantedCommit:t?.targetCommitSha});if(r.code===g.s.ERROR)c(r.error);else{const e=new Map;r.payload[0].forEach((t=>e.set(t.sha,t))),T(e),W(r.payload[1]??null)}}),[a.remoteRepositoryOwner,a.remoteRepositoryName,e.head,t?.targetCommitSha]);(0,n.useEffect)((()=>d?void Q():void 0),[d,Q]),(0,n.useEffect)((()=>E?void Q():void 0),[E,Q]),(0,n.useEffect)((()=>h(!1)),[i]),(0,n.useEffect)((()=>C(i?i[1]:"")),[i]);let F;t&&(R?.has(t.targetCommitSha)?F=R?.get(t.targetCommitSha):D?.sha===t.targetCommitSha&&(F=D));const K=[...(R??[]).values()].map((a=>({name:a.name,value:a.sha,current:a.sha===t?.targetCommitSha,latest:a.sha===e.head,disabled:!1})));D&&(K.push({name:"...",value:"",current:!1,latest:!1,disabled:!0}),K.push({name:D.name,value:D.sha,current:D.sha===t?.targetCommitSha,latest:D.sha===e.head,disabled:!1}));const X=(0,w.bQ)(B.instancePermissionSet,p.WX.MergePullRequest),V=(0,w.bQ)(B.instancePermissionSet,p.WX.Read)&&(0,w.bQ)(B.instancePermissionSet,p.WX.UpdateBranch)||!t;return n.createElement(n.Fragment,null,n.createElement("tr",null,n.createElement("td",{className:"text-right"+(i?" font-weight-bold":"")},"#",e.number),n.createElement("td",null,n.createElement(U.A,{pill:!0,className:"text-white text-capitalize mr-2",style:{backgroundColor:{closed:"#c93c37",merged:"#8256d0",open:"#347d39"}[e.state]}},e.state),e.testmergelabel?n.createElement(U.A,{pill:!0,className:"text-white text-capitalize mr-2",variant:"primary"},n.createElement(m.A,{id:"view.instance.repo.testmergelabel"})):null,e.conflictlabel?n.createElement(U.A,{pill:!0,className:"text-white text-capitalize mr-2",variant:"danger"},n.createElement(m.A,{id:"view.instance.repo.conflictlabel"})):null),n.createElement("td",null,n.createElement("a",{href:e.link,target:"_blank",rel:"noreferrer"},e.title)),n.createElement("td",{className:"font-italic"},e.author),n.createElement("td",null,n.createElement("div",{className:"d-flex justify-content-center"},n.createElement("div",{className:"d-inline-block text-nowrap"},i?n.createElement(n.Fragment,null,n.createElement(k.A,{tooltipid:"generic.no_perm",show:!V&&void 0},n.createElement(r.A,{variant:"danger",className:"mx-1",onClick:l,disabled:!V},n.createElement(M.g,{icon:"minus",fixedWidth:!0}))),n.createElement(k.A,{tooltipid:"generic.no_perm",show:(!X||!V)&&void 0},n.createElement(r.A,{className:"mx-1",onClick:a=>a.shiftKey?o(e.head,t?.comment??null):f(!0),variant:i[0]===e.head?"primary":"info",disabled:!X||!V},n.createElement(M.g,{icon:"sync",fixedWidth:!0}))),t?n.createElement(r.A,{className:"mx-1",onClick:()=>h((e=>!e)),active:d},n.createElement(M.g,{icon:"info",fixedWidth:!0})):null):n.createElement(k.A,{tooltipid:"generic.no_perm",show:!X&&void 0},n.createElement(r.A,{variant:"success",className:"mx-1",disabled:!X,onClick:t=>t.shiftKey?o(e.head,null):f(!0)},n.createElement(M.g,{icon:"plus",fixedWidth:!0}))))))),n.createElement("tr",null,n.createElement("td",{className:"py-0 border-top-0"}),n.createElement("td",{colSpan:4,className:"py-0 border-top-0"},t?n.createElement(N.A,{in:d},n.createElement("div",null,n.createElement("div",{className:"py-3"},n.createElement("table",{className:"reset-table"},n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",{className:"text-nowrap"},n.createElement("span",{className:"p-2"},n.createElement(m.A,{id:"view.instance.repo.tm.by"}))),n.createElement("td",null,t.mergedBy.name)),n.createElement("tr",null,n.createElement("td",{className:"text-nowrap"},n.createElement("span",{className:"p-2"},n.createElement(m.A,{id:"view.instance.repo.tm.comment"}))),n.createElement("td",null,t.comment)),n.createElement("tr",null,n.createElement("td",{className:"text-nowrap"},n.createElement("span",{className:"p-2"},n.createElement(m.A,{id:"view.instance.repo.tm.commit"}))),n.createElement("td",null,F?n.createElement(n.Fragment,null,F.name,n.createElement("a",{className:"ml-1",href:F.url,target:"_blank",rel:"noreferrer"},"(",t.targetCommitSha.substring(0,7),")")):t.targetCommitSha.substring(0,7)))))))):null)),n.createElement(s.A,{show:E,onHide:()=>f(!1),centered:!0,size:"lg"},n.createElement(s.A.Header,{closeButton:!0},n.createElement(s.A.Title,null,n.createElement(m.A,{id:"view.instance.repo.tm.modal.title"}))),n.createElement(s.A.Body,null,n.createElement("h5",null,n.createElement("a",{href:e.link,target:"_blank",rel:"noreferrer",className:"text-decoration-none"},e.title)),n.createElement(m.A,{id:"view.instance.repo.tm.modal.label"}),R?n.createElement(I.A,{filterOptions:H.A,search:!0,options:K,value:y??F?.sha,autoComplete:"on",renderOption:(e,t,a,r)=>n.createElement("button",O({type:"button",className:r+(t.disabled?" font-weight-bold":"")},e),n.createElement(U.A,null,t.value.substring(0,7)),t.current?n.createElement(U.A,{variant:"primary",pill:!0,className:"mr-1"},n.createElement(m.A,{id:"generic.testmerged"})):null,t.latest?n.createElement(U.A,{variant:"success",pill:!0,className:"mr-1"},n.createElement(m.A,{id:"generic.latest"})):null,t.name),onChange:e=>b(e)}):n.createElement(x.default,{text:"loading.repo.commits",width:5,widthUnit:"rem"}),n.createElement(P.Ay,{name:"view.instance.repo.tm.modal.comment",type:P.PU.String,onChange:e=>C(e),defaultValue:t?.comment??""}),n.createElement("span",{className:"text-muted font-italic mt-4 d-inline-block"},n.createElement(m.A,{id:"view.instance.repo.tm.modal.tip"}))),n.createElement(s.A.Footer,null,n.createElement(r.A,{variant:"danger",onClick:()=>f(!1)},n.createElement(m.A,{id:"generic.close"})),n.createElement(r.A,{onClick:()=>{y&&o(y,S),f(!1)}},n.createElement(m.A,{id:"generic.save"})))))}function W(){return W=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)({}).hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},W.apply(null,arguments)}var B=function(e){return e.reapply="reapply",e.added="added",e.removed="removed",e.updated="updated",e.rename="renamed",e}(B||{}),Q=function(e){return e[e.None=0]="None",e[e.Local=1]="Local",e[e.Remote=2]="Remote",e}(Q||{}),F=function(e){return e[e.None=0]="None",e[e.Password=1]="Password",e[e.Token=2]="Token",e[e.PrivateKey=3]="PrivateKey",e}(F||{});class K extends n.Component{constructor(e){super(e),this.state={errors:[],repositoryInfo:null,writableCredentials:null,credMode:F.PrivateKey,showCredsModal:!1,loading:!0,cloning:!1,unableToHookClone:!1,gitHubPRs:null,manualPRs:new Set,resetType:Q.Remote,desiredState:new Map,showDeleteModal:!1,showRecloneModal:!1,manualPR:0,lastManualPR:0,deployAfter:!1,repoBusy:!1,loadingPRs:!1},this.fetchRepositoryInfo=this.fetchRepositoryInfo.bind(this)}addError(e){this.setState((t=>{const a=Array.from(t.errors);return a.push(e),{errors:a}}))}async componentDidMount(){this.setState({deployAfter:(0,w.eG)(this.context.instancePermissionSet,p.rY.Compile)}),await this.fetchRepositoryInfo(void 0,!0)}async fetchRepositoryInfo(e,t){(0,w.bQ)(this.context.instancePermissionSet,p.WX.Read)||(this.setState({loading:!1,cloning:!1}),this.reloadDesiredState(null,t??!1,!1),this.setState({repositoryInfo:null,credMode:F.PrivateKey}));const a=await f.A.getRepository(this.context.instance.id);if(this.setState({cloning:!1,repoBusy:!1}),a.code===g.s.ERROR)if(a.error.code===E.O4.HTTP_DATA_INEGRITY&&a.error.originalErrorMessage?.errorCode===p.vH.RepoCloning)if(this.setState({cloning:!0,unableToHookClone:!1}),e)b.default.registerCallback(e.id,this.fetchRepositoryInfo);else{const e=await h.A.listActiveJobs(this.context.instance.id,{page:1,pageSize:100});if(e.code===g.s.OK){const t=e.payload.content.sort(((e,t)=>t.id-e.id)).find((e=>e.description.includes("Clone")&&e.description.includes("repository")));t?b.default.registerCallback(t.id,this.fetchRepositoryInfo):this.setState({unableToHookClone:!0})}else this.addError(e.error),this.setState({unableToHookClone:!0})}else a.error.code===E.O4.HTTP_DATA_INEGRITY&&a.error.originalErrorMessage?.errorCode===p.vH.RepoBusy?this.setState({repoBusy:!0}):this.addError(a.error);else this.reloadPRs(a.payload,t),this.setState({repositoryInfo:a.payload,credMode:F.PrivateKey});this.setState({loading:!1})}reloadPRs(e,t){e.remoteGitProvider===p.mA.GitHub&&e.remoteRepositoryName&&e.remoteRepositoryOwner&&(this.setState({loadingPRs:!0}),A.A.getPRs({repo:e.remoteRepositoryName,owner:e.remoteRepositoryOwner,wantedPRs:e.revisionInformation?.activeTestMerges.map((e=>e.number))}).then((a=>{this.setState({loadingPRs:!1}),a.code===g.s.ERROR?this.addError(a.error):(this.setState({gitHubPRs:a.payload}),t&&this.reloadDesiredState(e,!0,!1,a.payload))})).catch((e=>{this.setState({loadingPRs:!1}),this.addError(new E.Ay(E.O4.APP_FAIL,{jsError:e}))})))}async applyTestmerges(e){const t={},a=this.state.repositoryInfo,n=this.state.resetType!==Q.None;if(this.state.resetType===Q.Local?t.checkoutSha=a?.revisionInformation?.originCommitSha:this.state.resetType===Q.Remote&&(t.updateFromOrigin=!0,t.reference=a?.reference),a&&a?.remoteGitProvider===p.mA.GitHub){const a=[];[...this.state.desiredState.entries()].forEach((([t,r])=>{if(!r)return;const[s,i,l]=r;(!s||n||e)&&a.push({number:t,targetCommitSha:i,comment:l})})),a.length&&(t.newTestMerges=a)}const r=t.newTestMerges??[];this.state.manualPRs.forEach((e=>r.push({number:e}))),r.length&&(t.newTestMerges=r),this.setState({loading:!0});const s=await f.A.editRepository(this.context.instance.id,t);if(this.setState({loading:!1}),s.code===g.s.OK)if(s.payload.activeJob){if(this.setState({loading:!0}),b.default.fastmode=5,b.default.registerCallback(s.payload.activeJob.id,(e=>this.fetchRepositoryInfo(e,void 0===e.errorCode&&void 0===e.exceptionDetails))),b.default.registerJob(s.payload.activeJob,this.context.instance.id),this.state.deployAfter){const e=s.payload.activeJob.id,t=setInterval((()=>{const a=b.default.jobs.get(e);("number"==typeof a?.progress||a?.stoppedAt)&&(u.A.startCompile(this.context.instance.id).then((e=>{e.code===g.s.ERROR&&this.addError(e.error)})),clearInterval(t))}),5e3)}}else await this.fetchRepositoryInfo();else this.addError(s.error)}reloadDesiredState(e,t,a,n){n=n??this.state.gitHubPRs,t&&this.setState((e=>({resetType:a?Q.None:e.resetType,manualPRs:new Set}))),e&&this.setState((r=>{const s=r.desiredState,i=new Map(t?[]:s);let l=!1;const o=t&&!a;e.revisionInformation?.activeTestMerges.forEach((e=>{const a=i.get(e.number);if(!t){if(!a)return;if(a&&!a[0])return}const r=n?.find((t=>e.number===t.number));if(o&&!("merged"!==r?.state))i.set(e.number,null),l=!0;else{const t=(o?r?.head:null)??e.targetCommitSha;o&&t!==e.targetCommitSha&&(l=!0),i.set(e.number,[!0,t,e.comment??""])}}));return{resetType:l?"(no branch)"===e.reference?Q.Local:Q.Remote:r.resetType,desiredState:i}}))}render(){return n.createElement("div",{className:"text-center"},n.createElement(T.Q,{obj:this.state}),this.renderErrors(),this.state.cloning?n.createElement(x.default,{text:"loading.repo.cloning"}):this.state.repositoryInfo&&!this.state.repositoryInfo.origin?this.renderPreClone():n.createElement(n.Fragment,null,n.createElement("h3",null,n.createElement(m.A,{id:"view.instance.repo.repoinfo"})),this.state.repoBusy?n.createElement(x.default,{text:"loading.repo.busy"}):n.createElement(n.Fragment,null,this.renderRepoInformation(),n.createElement("hr",null),this.renderSettings(),n.createElement("hr",null),this.renderTestMerges(),n.createElement("hr",null),this.renderReclone(),n.createElement("hr",null),this.renderDelete())))}renderErrors(){return n.createElement(n.Fragment,null,this.state.errors.map(((e,t)=>{if(e)return n.createElement(S.Ay,{key:t,error:e,onClose:()=>this.setState((e=>{const a=Array.from(e.errors);return a[t]=void 0,{errors:a}}))})})))}renderRepoInformation(){const e=this.state.repositoryInfo;return e?n.createElement("table",{className:"mx-auto text-left"},n.createElement("tbody",null,n.createElement("tr",null,n.createElement("td",null,n.createElement("span",{className:"mr-3"},n.createElement(m.A,{id:"view.instance.repo.info.origin"}))),n.createElement("td",null,e.origin)),n.createElement("tr",null,n.createElement("td",null,n.createElement("span",{className:"mr-3"},n.createElement(m.A,{id:"view.instance.repo.info.owner"}))),n.createElement("td",null,e.remoteRepositoryOwner)),n.createElement("tr",null,n.createElement("td",null,n.createElement("span",{className:"mr-3"},n.createElement(m.A,{id:"view.instance.repo.info.name"}))),n.createElement("td",null,e.remoteRepositoryName)))):n.createElement(C.A,{title:"view.instance.repo.norepoinfo"})}renderPreClone(){const e={origin:{type:P.PU.String,name:"fields.instance.repository.url"},reference:{type:P.PU.String,name:"fields.instance.repository.ref",defaultValue:""},updateSubmodules:{type:P.PU.Boolean,name:"fields.instance.repository.enablesubmodules",defaultValue:!0}};return n.createElement(n.Fragment,null,n.createElement("h3",null,n.createElement(m.A,{id:"view.instance.repo.clone"})),this.renderCredsModal(),n.createElement(R.A,{fields:e,hideDisabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.Read),onSave:async e=>{const t={...e};""==e.reference&&(t.reference=null),this.state.writableCredentials&&(t.accessUser=this.state.writableCredentials.accessUser,t.accessToken=this.state.writableCredentials.accessToken);const a=await f.A.cloneRepository(this.context.instance.id,t);a.code===g.s.OK?(this.setState({writableCredentials:null}),await this.fetchRepositoryInfo(a.payload.activeJob??void 0)):this.addError(a.error)},includeAll:!0,alwaysAllowSave:!!this.state.writableCredentials,saveMessageId:"generic.clone"}))}renderSettings(){const e=this.state.repositoryInfo,t={originCheckoutSha:{type:P.PU.String,name:"fields.instance.repository.origincheckoutsha",disabled:!0,defaultValue:e?e.revisionInformation?.originCommitSha:"",tooltip:"fields.instance.repository.origincheckoutsha.desc"},checkoutSha:{type:P.PU.String,name:"fields.instance.repository.checkoutsha",defaultValue:e?e.revisionInformation?.commitSha:"",tooltip:"fields.instance.repository.checkoutsha.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.SetSha)},reference:{type:P.PU.String,name:"fields.instance.repository.reference",defaultValue:e?e.reference:"",tooltip:"fields.instance.repository.reference.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.SetReference)},committerName:{type:P.PU.String,name:"fields.instance.repository.committerName",defaultValue:e?e.committerName:"",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeCommitter)},committerEmail:{type:P.PU.String,name:"fields.instance.repository.committerEmail",defaultValue:e?e.committerEmail:"",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeCommitter)},pushTestMergeCommits:{type:P.PU.Boolean,name:"fields.instance.repository.pushTestMergeCommits",defaultValue:!!e&&e.pushTestMergeCommits,tooltip:"fields.instance.repository.pushTestMergeCommits.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeTestMergeCommits)},createGitHubDeployments:{type:P.PU.Boolean,name:"fields.instance.repository.createGitHubDeployments",defaultValue:!!e&&e.createGitHubDeployments,tooltip:"fields.instance.repository.createGitHubDeployments.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeTestMergeCommits)},showTestMergeCommitters:{type:P.PU.Boolean,name:"fields.instance.repository.showTestMergeCommitters",defaultValue:!!e&&e.showTestMergeCommitters,tooltip:"fields.instance.repository.showTestMergeCommitters.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeTestMergeCommits)},autoUpdatesKeepTestMerges:{type:P.PU.Boolean,name:"fields.instance.repository.autoUpdatesKeepTestMerges",defaultValue:!!e&&e.autoUpdatesKeepTestMerges,tooltip:"fields.instance.repository.autoUpdatesKeepTestMerges.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeAutoUpdateSettings)},autoUpdatesSynchronize:{type:P.PU.Boolean,name:"fields.instance.repository.autoUpdatesSynchronize",defaultValue:!!e&&e.autoUpdatesSynchronize,tooltip:"fields.instance.repository.autoUpdatesSynchronize.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeAutoUpdateSettings)},postTestMergeComment:{type:P.PU.Boolean,name:"fields.instance.repository.postTestMergeComment",defaultValue:!!e&&e.postTestMergeComment,tooltip:"fields.instance.repository.postTestMergeComment.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeTestMergeCommits)},updateSubmodules:{type:P.PU.Boolean,name:"fields.instance.repository.updateSubmodules",defaultValue:!!e&&e.updateSubmodules,tooltip:"fields.instance.repository.updateSubmodules.desc",disabled:!(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeSubmoduleUpdate)}};return n.createElement(n.Fragment,null,n.createElement("h3",null,n.createElement(m.A,{id:"view.instance.repo.reposettings"})),this.renderCredsModal(),n.createElement(R.A,{fields:t,onSave:async e=>{this.setState({loading:!0,writableCredentials:null});const t={...e};this.state.writableCredentials&&(t.accessUser=this.state.writableCredentials.accessUser,t.accessToken=this.state.writableCredentials.accessToken);const a=await f.A.editRepository(this.context.instance.id,t);this.setState({loading:!1}),a.code===g.s.OK?a.payload.activeJob?(this.setState({loading:!0}),b.default.fastmode=5,b.default.registerCallback(a.payload.activeJob.id,(()=>this.fetchRepositoryInfo(void 0,!0))),b.default.registerJob(a.payload.activeJob,this.context.instance.id)):await this.fetchRepositoryInfo():this.addError(a.error)},alwaysAllowSave:!!this.state.writableCredentials}))}renderCredDetails(){const e=this.state.credMode,t=this.state.writableCredentials,a=this.state.repositoryInfo,[r]=Object.entries(F).find((([,t])=>t==e)),s=`fields.instance.repository.creds.mode.${r}`,i={username:{type:P.PU.String,name:s+".username",tooltip:s+".username.desc",defaultValue:t?.accessUser??a?.accessUser??""}},l={...i,token:{type:P.PU.Password,name:s+".token",tooltip:s+".token.desc",defaultValue:t?.accessToken??""}},o={...i,clientId:{type:P.PU.String,name:s+".id",tooltip:s+".id.desc"},privateKey:{type:P.PU.TextArea,name:s+".pk",tooltip:s+".pk.desc"}};return n.createElement(n.Fragment,null,n.createElement("div",{style:{display:e!=F.PrivateKey?"none":void 0}},n.createElement(R.A,{fields:o,onSave:e=>{const t=e.username?.trim(),a=e.clientId?.trim(),n=e.privateKey?.trim();if(!t?.length||!a?.length||!n?.length)return void alert("Please enter a username, client/app ID, and private key!");const r=`TGS_PK_${a}:${btoa(n)}`;this.setState({writableCredentials:{accessUser:t,accessToken:r},showCredsModal:!1})}})),n.createElement("div",{style:{display:e==F.PrivateKey?"none":void 0}},n.createElement(R.A,{fields:l,onSave:t=>{const a=t.username?.trim(),n=t.token?.trim();a?.length&&n?.length?this.setState({writableCredentials:{accessUser:a,accessToken:n},showCredsModal:!1}):alert(`Please enter both a username and a ${e==F.Password?"password":"token"}!`)}})))}renderCredsModal(){const e=(0,w.bQ)(this.context.instancePermissionSet,p.WX.ChangeCredentials),t=n.createElement(r.A,{disabled:!e,onClick:()=>this.setState({showCredsModal:!0})},n.createElement(m.A,{id:"generic.edit"})),a=this.state.credMode;return n.createElement(n.Fragment,null,n.createElement(s.A,{show:this.state.showCredsModal,onHide:()=>this.setState({showCredsModal:!1}),centered:!0,size:"lg"},n.createElement(s.A.Header,{closeButton:!0},n.createElement(s.A.Title,null,n.createElement(m.A,{id:"view.instance.repo.creds.modal.title"}))),n.createElement(s.A.Body,null,n.createElement(P.Ay,{name:"fields.instance.repository.creds.mode",type:P.PU.Enum,enum:F,defaultValue:a,onChange:e=>this.setState({credMode:e})}),a!=F.None?this.renderCredDetails():n.createElement(s.A.Footer,null,n.createElement(r.A,{className:"text-center",variant:"danger",onClick:()=>this.setState({showCredsModal:!1,writableCredentials:{accessUser:"",accessToken:""}})},n.createElement(m.A,{id:"generic.save"})),n.createElement(r.A,{className:"text-center",onClick:()=>this.setState({showCredsModal:!1,writableCredentials:null})},n.createElement(m.A,{id:"generic.reset"}))),a!=F.None?n.createElement(s.A.Footer,null,n.createElement(r.A,{className:"text-center",onClick:()=>this.setState({showCredsModal:!1,writableCredentials:null})},n.createElement(m.A,{id:"generic.reset"}))):null)),n.createElement("div",{className:"d-flex mt-5"},n.createElement(P.Ay,{name:"view.instance.repo.creds",tooltip:"view.instance.repo.creds.desc",type:P.PU.String,defaultValue:(this.state.writableCredentials?this.state.writableCredentials.accessUser:this.state.repositoryInfo?.accessUser)||"(Unset)",onChange:()=>{},disabled:!0,hideReadOnly:!0,additionalAppend:t,forceChanged:!!this.state.writableCredentials})))}renderTestMerges(){const e=this.state.repositoryInfo,t=(0,w.eG)(this.context.instancePermissionSet,p.rY.Compile),a=(0,w.bQ)(this.context.instancePermissionSet,p.WX.MergePullRequest),s=(0,w.bQ)(this.context.instancePermissionSet,p.WX.Read)&&(0,w.bQ)(this.context.instancePermissionSet,p.WX.UpdateBranch),u=new Map;e&&e.revisionInformation?.activeTestMerges.forEach((e=>u.set(e.number,e)));const h=this.state.gitHubPRs?.sort(((e,t)=>u.has(e.number)!==u.has(t.number)?u.has(e.number)?-1:1:e.testmergelabel!==t.testmergelabel?e.testmergelabel?-1:1:e.conflictlabel!==t.conflictlabel?e.conflictlabel?1:-1:e.number-t.number))??[],E=h.map((t=>{const a=this.state.desiredState.get(t.number),n=e?e?.revisionInformation?.activeTestMerges.find((e=>e.number===t.number)):void 0;return a?n?n.targetCommitSha!==a[1]?[B.updated,t]:(n.comment??"")!==a[2]?[B.rename,t]:[B.reapply,t]:[B.added,t]:this.state.desiredState.get(t.number)?null:n?[B.removed,t]:null})).filter((e=>null!==e)),g=E.sort(((e,t)=>{const a=[B.removed,B.reapply,B.added,B.updated];for(const n of a)if(e[0]===n^t[0]===n)return e[0]===n?-1:1;return 0})),f=!!e&&"(no branch)"===e.reference,b=E.some((e=>e[0]!=B.added&&e[0]!=B.reapply)),v=0===E.filter((([e])=>e!==B.reapply)).length&&this.state.resetType===Q.None&&!this.state.manualPRs.size;return e&&e.remoteGitProvider==p.mA.Unknown?n.createElement(C.A,{title:"view.instance.repo.testmerges.badprovider"}):n.createElement("div",{className:"mx-5"},n.createElement(i.A,{className:"mb-5"},n.createElement(i.A.Header,null,n.createElement(m.A,{id:"view.instance.repo.pending.title"})),n.createElement(i.A.Body,{className:"text-left"},n.createElement("ul",null,v?n.createElement("li",{className:"font-weight-lighter font-italic"},n.createElement(m.A,{id:"view.instance.repo.pending.none"})):n.createElement(n.Fragment,null,e&&f?n.createElement("li",null,n.createElement(m.A,{id:"view.instance.repo.pending.reset.nobranch",values:{commit:e.revisionInformation?.originCommitSha.substring(0,7)}})):this.state.resetType===Q.Remote?n.createElement("li",null,n.createElement(m.A,{id:"view.instance.repo.pending.update"})):this.state.resetType===Q.Local?n.createElement("li",null,n.createElement(m.A,{id:"view.instance.repo.pending.reset"})):null,e&&e.remoteGitProvider===p.mA.GitHub?g.map((([e,t])=>{const a=this.state.desiredState.get(t.number);if(e===B.reapply&&this.state.resetType===Q.None&&!f)return null;let r=a?a[1].substring(0,7):null;const s=this.state.gitHubPRs?.find((e=>t.number===e.number));return r&&!s?.head.startsWith(r)||(r=`HEAD (${(r??s.head).substring(0,7)})`),n.createElement("li",{key:t.number},n.createElement(m.A,{id:`view.instance.repo.pending.${e}`,values:{number:t.number,commit:r,title:t.title}}))})):null,[...this.state.manualPRs.values()].map((e=>n.createElement("li",{key:e},n.createElement(m.A,{id:"view.instance.repo.pending.added.manual",values:{number:e}})))),this.state.deployAfter?n.createElement("li",{key:"deploy"},n.createElement(m.A,{id:"view.instance.repo.pending.deploy"})):null)),n.createElement(l.A,{size:"lg",className:"mb-2 text-center"},n.createElement(r.A,{disabled:f||!s,onClick:()=>this.setState({resetType:Q.Remote}),variant:this.state.resetType===Q.Remote?"secondary":"primary"},n.createElement(m.A,{id:"view.instance.repo.update.remote"})),n.createElement(o.A,{placement:"top",overlay:e=>n.createElement(c.A,W({id:"repo-local-reset-tip"},e),n.createElement(m.A,{id:"view.instance.repo.update.local.tip"}))},n.createElement(r.A,{onClick:()=>this.setState({resetType:Q.Local}),variant:this.state.resetType===Q.Local?"secondary":"primary"},n.createElement(m.A,{id:"view.instance.repo.update.local"}))),n.createElement(r.A,{disabled:b,onClick:()=>this.setState({resetType:Q.None}),variant:this.state.resetType===Q.None?"secondary":"primary"},n.createElement(m.A,{id:"view.instance.repo.update.none"}))),!y.Ay.manualpr.value&&e&&this.state.gitHubPRs&&e.remoteGitProvider!==p.mA.GitLab?null:n.createElement("div",{className:"d-flex mt-5"},n.createElement(P.Ay,{name:"view.instance.repo.manual",tooltip:"view.instance.repo.manual.desc",type:P.PU.Number,min:0,defaultValue:this.state.lastManualPR,onChange:e=>this.setState({manualPR:e}),disabled:!a}),n.createElement(k.A,{tooltipid:"generic.no_perm",show:!a&&void 0},n.createElement(r.A,{className:"nowrap ml-3",disabled:this.state.manualPR===this.state.lastManualPR||!a,onClick:()=>{this.setState((e=>({manualPRs:new Set([...e.manualPRs.values(),this.state.manualPR]),lastManualPR:this.state.manualPR})))}},n.createElement(m.A,{id:"view.instance.repo.addmanual"})))),n.createElement(P.Ay,{name:"view.instance.repo.deployAfter",tooltip:"view.instance.repo.deployAfter.desc",type:P.PU.Boolean,defaultValue:!!t&&this.state.deployAfter,disabled:!t,onChange:e=>this.setState({deployAfter:e})})),n.createElement(i.A.Footer,null,n.createElement(r.A,{variant:"danger",className:"mx-2",disabled:v,onClick:()=>this.reloadDesiredState(e,!0,!0)},n.createElement(m.A,{id:"generic.cancel"})),n.createElement(r.A,{className:"mx-2",disabled:v,onClick:()=>{this.applyTestmerges(f)}},n.createElement(m.A,{id:"generic.commit"})))),this.state.loadingPRs?n.createElement(x.default,{text:"loading.repo.prs"}):e?e&&e.remoteGitProvider===p.mA.GitHub?n.createElement(n.Fragment,null,n.createElement("h3",null,n.createElement(m.A,{id:"view.instance.repo.testmerges"})),n.createElement("br",null),n.createElement(d.A,{variant:"dark",striped:!0,hover:!0,className:"text-left"},n.createElement("tbody",null,h.map((t=>n.createElement(D,{key:t.number,testmergeinfo:u.get(t.number),pr:t,repoInfo:e,finalState:!!this.state.desiredState.get(t.number)&&this.state.desiredState.get(t.number).slice(1),onRemove:()=>this.setState((e=>({resetType:e.resetType===Q.None?Q.Remote:e.resetType,desiredState:new Map(e.desiredState).set(t.number,null)}))),onSelectCommit:(e,a)=>this.setState((n=>({desiredState:new Map(n.desiredState).set(t.number,[!1,e,a])}))),onError:e=>this.addError(e)})))))):null:n.createElement(C.A,{title:"view.instance.repo.noautomerge"}))}renderReclone(){const e=(0,w.bQ)(this.context.instancePermissionSet,p.WX.Reclone);return n.createElement(n.Fragment,null,n.createElement("h4",null,n.createElement(m.A,{id:"view.instance.repo.reclone.title"})),n.createElement("span",null,n.createElement(m.A,{id:"view.instance.repo.reclone.desc"})),n.createElement("br",null),n.createElement(r.A,{variant:"warning",className:"mt-2",disabled:!e,onClick:()=>this.setState({showRecloneModal:!0})},n.createElement(m.A,{id:"view.instance.repo.reclone"})),n.createElement(s.A,{show:this.state.showRecloneModal,onHide:()=>this.setState({showRecloneModal:!1}),centered:!0},n.createElement(s.A.Header,{closeButton:!0},n.createElement(s.A.Title,null,n.createElement(m.A,{id:"view.instance.repo.reclone.title"}))),n.createElement(s.A.Body,null,n.createElement("span",null,n.createElement(m.A,{id:"generic.areyousure"}))),n.createElement(s.A.Footer,null,n.createElement(r.A,{onClick:()=>this.setState({showRecloneModal:!1})},n.createElement(m.A,{id:"generic.cancel"})),n.createElement(r.A,{variant:"danger",onClick:()=>{(async()=>{this.setState({showRecloneModal:!1,loading:!0});const e=await f.A.recloneRepository(this.context.instance.id);this.setState({loading:!1}),e.code===g.s.OK?e.payload.activeJob?(this.setState({loading:!0}),b.default.fastmode=5,b.default.registerCallback(e.payload.activeJob.id,(e=>this.fetchRepositoryInfo(e,void 0===e.errorCode&&void 0===e.exceptionDetails))),b.default.registerJob(e.payload.activeJob,this.context.instance.id)):await this.fetchRepositoryInfo():this.addError(e.error)})()}},n.createElement(m.A,{id:"view.instance.repo.reclone"})))))}renderDelete(){const e=(0,w.bQ)(this.context.instancePermissionSet,p.WX.Delete);return n.createElement(n.Fragment,null,n.createElement("h4",null,n.createElement(m.A,{id:"view.instance.repo.delete.title"})),n.createElement("span",null,n.createElement(m.A,{id:"view.instance.repo.delete.desc"})),n.createElement("br",null),n.createElement(r.A,{variant:"danger",className:"mt-2",disabled:!e,onClick:()=>this.setState({showDeleteModal:!0})},n.createElement(m.A,{id:"view.instance.repo.delete"})),n.createElement(s.A,{show:this.state.showDeleteModal,onHide:()=>this.setState({showDeleteModal:!1}),centered:!0},n.createElement(s.A.Header,{closeButton:!0},n.createElement(s.A.Title,null,n.createElement(m.A,{id:"view.instance.repo.delete.title"}))),n.createElement(s.A.Body,null,n.createElement("span",null,n.createElement(m.A,{id:"generic.areyousure"}))),n.createElement(s.A.Footer,null,n.createElement(r.A,{onClick:()=>this.setState({showDeleteModal:!1})},n.createElement(m.A,{id:"generic.cancel"})),n.createElement(r.A,{variant:"danger",onClick:()=>{(async()=>{this.setState({showDeleteModal:!1,loading:!0});const e=await f.A.deleteRepository(this.context.instance.id);this.setState({loading:!1}),e.code===g.s.OK?e.payload.activeJob?(this.setState({loading:!0}),b.default.fastmode=5,b.default.registerCallback(e.payload.activeJob.id,(e=>this.fetchRepositoryInfo(e,void 0===e.errorCode&&void 0===e.exceptionDetails))),b.default.registerJob(e.payload.activeJob,this.context.instance.id)):await this.fetchRepositoryInfo():this.addError(e.error)})()}},n.createElement(m.A,{id:"view.instance.repo.delete"})))))}}K.contextType=v.z;var X=K}}]);
//# sourceMappingURL=3649.0d0a11552793ceeeb522.bundle.js.map
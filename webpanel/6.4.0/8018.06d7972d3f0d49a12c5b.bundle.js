"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[8018],{8018:function(e,t,a){a.r(t);var n=a(6540),s=a(6052),i=a(5615),l=a(5038),r=a(3524),c=a(8065),o=a(8798),d=a(1683),m=a(9589),u=a(4366),f=a(2576),p=a(5301),v=a(379),h=a(7621),w=a(4118),g=a(9956),S=a(7567),E=a(5659),b=a(1723),N=a(6113),A=a(6795),P=a(7255),y=function(e){return e[e.None=0]="None",e[e.Stop=1]="Stop",e[e.Restart=2]="Restart",e}(y||{});t.default=(0,o.Ay)((function(e){const t=(0,n.useContext)(h.z),[a,o]=(0,n.useState)(),[C,R]=(0,n.useState)(!1),_=(0,n.useState)([]);async function B(){if(!(0,w.GY)(t.instancePermissionSet,f.NB.ReadMetadata))return o({});const e=await u.A.getWatchdogStatus(t.instance.id);e.code===p.s.ERROR?(0,S.CN)(_,e.error):o(e.payload)}async function G(e){R(!0);const a=await u.A.updateWatchdogStatus(t.instance.id,e);a.code===p.s.ERROR&&(0,S.CN)(_,a.error),await B(),R(!1)}if((0,n.useEffect)((()=>{B()}),[t.instance.id]),!a)return n.createElement(n.Fragment,null,(0,S.u9)(_));if(C)return n.createElement(P.default,null);const Y={autoStart:{type:b.PU.Boolean,name:"fields.instance.watchdog.autostart",defaultValue:a.autoStart,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetAutoStart)},startProfiler:{type:b.PU.Boolean,name:"fields.instance.watchdog.autostartprofiler",defaultValue:a.startProfiler,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetProfiler)},logOutput:{type:b.PU.Boolean,name:"fields.instance.watchdog.logoutput",defaultValue:a.logOutput,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetLogOutput)},port:{type:b.PU.Number,name:"fields.instance.watchdog.port",defaultValue:a.port,min:0,max:65535,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetPort)},visibility:{type:b.PU.Enum,name:"fields.instance.watchdog.visibility",defaultValue:a.visibility,enum:f.mS,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetVisibility)},securityLevel:{type:b.PU.Enum,name:"fields.instance.watchdog.securitylevel",defaultValue:a.securityLevel,enum:f.GZ,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetSecurity)},startupTimeout:{type:b.PU.Number,name:"fields.instance.watchdog.timeout.startup",defaultValue:a.startupTimeout,min:0,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetStartupTimeout)},topicRequestTimeout:{type:b.PU.Number,name:"fields.instance.watchdog.timeout.topic",defaultValue:a.topicRequestTimeout,min:0,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetTopicTimeout)},healthCheckSeconds:{type:b.PU.Number,name:"fields.instance.watchdog.healthcheck",defaultValue:a.healthCheckSeconds,min:0,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetHealthCheckInterval)},dumpOnHealthCheckRestart:{type:b.PU.Boolean,name:"fields.instance.watchdog.dumpOnHealthCheckRestart",defaultValue:a.dumpOnHealthCheckRestart,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.CreateDump)},minidumps:{type:b.PU.Boolean,name:"fields.instance.watchdog.minidumps",defaultValue:a.minidumps,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetMinidumps)},allowWebClient:{type:b.PU.Boolean,name:"fields.instance.watchdog.allowwebclient",defaultValue:a.allowWebClient,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetWebClient)},additionalParameters:{type:b.PU.String,name:"fields.instance.watchdog.additionalparams",defaultValue:a.additionalParameters,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetAdditionalParameters)},mapThreads:{type:b.PU.Number,name:"fields.instance.watchdog.mapthreads",defaultValue:a.mapThreads,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetMapThreads)},openDreamTopicPort:{type:b.PU.Number,name:"fields.instance.watchdog.od_topic_port",tooltip:"fields.instance.watchdog.od_topic_port.desc",defaultValue:a.openDreamTopicPort,min:0,max:65535,disabled:!(0,w.GY)(t.instancePermissionSet,f.NB.SetPort)}},k=Object.values(Y).some((e=>!e.disabled)),V=n.createElement(r.A,{id:"generic.no_perm"},n.createElement(c.A,{id:"generic.no_perm"})),O=(0,w.GY)(t.instancePermissionSet,f.NB.Start),T=(0,w.GY)(t.instancePermissionSet,f.NB.Shutdown),W=(0,w.GY)(t.instancePermissionSet,f.NB.Restart),U=(0,w.GY)(t.instancePermissionSet,f.NB.CreateDump),x=(0,w.GY)(t.instancePermissionSet,f.NB.ReadMetadata),M=(0,w.GY)(t.instancePermissionSet,f.NB.SoftShutdown)||(0,w.GY)(t.instancePermissionSet,f.NB.SoftRestart),D=O||T||W||U,J=!(0,w.GY)(t.instancePermissionSet,f.NB.BroadcastMessage)||x&&(a.status!==f._W.Online||null!=a.activeCompileJob?.dmApiVersion&&!(0,m.gte)(a.activeCompileJob?.dmApiVersion,"5.7.0")),H={message:{type:b.PU.String,name:"fields.instance.watchdog.broadcast",defaultValue:"",disabled:J,tooltip:"fields.instance.watchdog.broadcast.desc"}},L=(0,w.GY)(t.instancePermissionSet,f.NB.ReadRevision);let j=null;a&&(j={viewDataType:g.G.Watchdog,activeCompileJob:a.activeCompileJob,stagedCompileJob:a.stagedCompileJob});const q=1073741824,F=a?.immediateMemoryUsage,I=a?.clientCount,z=null!=I;let Q=!z&&x&&null!=a?.healthCheckSeconds&&a?.healthCheckSeconds>0&&(null==a.activeCompileJob?.dmApiVersion||!(0,m.gte)(a.activeCompileJob?.dmApiVersion,"5.10.0"));Q=!1;let Z=0;if(a?.launchTime&&a.healthCheckSeconds){const e=new Date(a.launchTime),t=((new Date).getTime()-e.getTime())/1e3;Z=Math.floor(a.healthCheckSeconds-t)}const $=!!a.launchTime;return n.createElement("div",{className:"text-center"},n.createElement(A.Q,{obj:a}),(0,S.u9)(_),n.createElement("h2",{className:"text-center"},n.createElement(c.A,{id:"view.instance.server.status"}),n.createElement(s.A,{pill:!0,variant:a.status===f._W.Online?"success":a.status===f._W.Offline?"danger":"warning"},n.createElement(c.A,{id:`view.instance.server.status.${f._W[a.status]}`}))),n.createElement("h4",null,F?n.createElement(s.A,{className:"status-badge",pill:!0,variant:j?.activeCompileJob?.engineVersion.engine==f.p3.OpenDream?"success":F>3221225472?"danger":F>2147483648?"warning":"success"},n.createElement("div",null,n.createElement(c.A,{id:"view.instance.server.status.ram"}),":\xa0",Math.round(F/q*100)/100,"GB")):null,z?n.createElement(s.A,{className:"status-badge",pill:!0,variant:0==I?"warning":"success"},n.createElement("div",null,n.createElement(c.A,{id:"view.instance.server.status.client_count"}),":\xa0",I)):null,null,z||a.status!==f._W.Online?null:n.createElement(s.A,{className:"status-badge",pill:!0,variant:"warning"},n.createElement("div",null,n.createElement(c.A,{id:Z>0?"view.instance.server.status.client_count.pending":"view.instance.server.status.client_count.soon",values:{healthCheckSecondsLeft:Z}}))),$?n.createElement(s.A,{className:"status-badge",pill:!0,variant:(()=>{const e=new Date(a.launchTime),t=(new Date).getMinutes()-e.getMinutes();return t<5?"danger":t<15?"warning":"success"})()},n.createElement("div",null,n.createElement(c.A,{id:"view.instance.server.status.uptime"}),n.createElement(d.A,{date:new Date(a.launchTime)}))):null),n.createElement("hr",null),L?n.createElement(g.A,{viewData:j}):n.createElement(E.A,{title:"view.instance.no_compile_jobs"}),n.createElement("hr",null),n.createElement("h3",{className:"text-center"},n.createElement(c.A,{id:"view.instance.server.settings"})),x?null:k?n.createElement(E.A,{title:"view.instance.no_metadata"}):n.createElement(E.A,{title:"view.instance.server.no_metadata_and_no_settings"}),n.createElement(N.A,{fields:Y,onSave:G,hideDisabled:!x}),n.createElement("hr",null),n.createElement("h3",{className:"text-center"},n.createElement(c.A,{id:"view.instance.server.actions"})),D?n.createElement(n.Fragment,null,x?null:n.createElement(E.A,{title:"view.instance.server.no_metadata_actions"}),n.createElement("div",{className:"text-center mb-3"},n.createElement(l.A,{overlay:V,show:!O&&void 0},n.createElement(i.A,{variant:"success",className:"mx-2",onClick:()=>{!async function(){R(!0);const e=await u.A.startWatchdog(t.instance.id);e.code===p.s.ERROR?(0,S.CN)(_,e.error):(v.default.registerCallback(e.payload.id,(()=>{B()})),v.default.fastmode=5,await B()),R(!1)}()},disabled:x&&a.status!=f._W.Offline||!O},n.createElement(c.A,{id:"view.instance.server.start"}))),n.createElement(l.A,{overlay:V,show:!T&&void 0},n.createElement(i.A,{variant:"danger",className:"mx-2",onClick:()=>{!async function(){if(!confirm(e.intl.formatMessage({id:"view.instance.server.prompt.stop"})))return;R(!0);const a=await u.A.stopWatchdog(t.instance.id);a.code===p.s.ERROR?(0,S.CN)(_,a.error):await B(),R(!1)}()},disabled:x&&a.status==f._W.Offline||!T},n.createElement(c.A,{id:"view.instance.server.stop"}))),n.createElement(l.A,{overlay:V,show:!W&&void 0},n.createElement(i.A,{variant:"warning",className:"mx-2",onClick:()=>{!async function(){if(!confirm(e.intl.formatMessage({id:"view.instance.server.prompt.restart"})))return;R(!0);const a=await u.A.restartWatchdog(t.instance.id);a.code===p.s.ERROR?(0,S.CN)(_,a.error):(v.default.registerCallback(a.payload.id,(()=>{B()})),v.default.fastmode=5,await B()),R(!1)}()},disabled:x&&a.status==f._W.Offline||!W},n.createElement(c.A,{id:"view.instance.server.restart"}))),n.createElement(l.A,{overlay:V,show:!U&&void 0},n.createElement(i.A,{variant:"info",className:"mx-2",onClick:()=>{!async function(){R(!0);const e=await u.A.dumpWatchdog(t.instance.id);e.code===p.s.ERROR?(0,S.CN)(_,e.error):v.default.fastmode=5,R(!1)}()},disabled:x&&a.status!=f._W.Online||!U},n.createElement(c.A,{id:"view.instance.server.dump"}))))):n.createElement(E.A,{title:"view.instance.server.no_actions"}),!x&&M?n.createElement(E.A,{title:"view.instance.server.no_metadata_graceful"}):null,x||M?n.createElement("div",{className:"w-75 mx-auto"},n.createElement(b.Ay,{name:"view.instance.graceful",type:b.PU.Enum,enum:y,tooltip:"view.instance.graceful.desc",defaultValue:a.softRestart?y.Restart:a.softShutdown?y.Stop:y.None,disabled:!M,onChange:e=>{switch(e){case y.None:if(!a?.softRestart&&!a?.softShutdown)return;G({softShutdown:!a.softShutdown&&void 0,softRestart:!a.softRestart&&void 0});break;case y.Stop:if(a?.softShutdown)return;G({softShutdown:!0});break;case y.Restart:if(a?.softRestart)return;G({softRestart:!0})}}})):D?n.createElement(E.A,{title:"view.instance.server.no_graceful"}):null,n.createElement("div",{className:"w-75 mx-auto"},n.createElement("br",null),n.createElement(N.A,{fields:H,onSave:e=>{G({broadcastMessage:e.message})},saveMessageId:"view.instance.server.broadcast"})))}))}}]);
//# sourceMappingURL=8018.06d7972d3f0d49a12c5b.bundle.js.map
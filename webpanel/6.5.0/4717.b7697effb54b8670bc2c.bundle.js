"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[4717],{6795:function(e,t,n){n.d(t,{Q:function(){return l}});var r=n(6540),s=n(8785),a=n.n(s),i=n(8437);function o(e){return r.createElement(a(),{src:e.obj,name:"JSON",theme:"tube",iconStyle:"triangle",collapsed:!0,displayDataTypes:!1})}function l(e){return i.Ay.showjson.value?r.createElement("div",{className:"text-left"},r.createElement(o,{obj:e.obj})):r.createElement(r.Fragment,null)}},5282:function(e,t,n){n.d(t,{A:function(){return d}});var r=n(6784),s=n(6540),a=n(5615),i=n(1208),o=n(5038),l=n(1069),c=n(3899),m=n(8065);function u(){return u=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},u.apply(null,arguments)}class d extends s.PureComponent{constructor(e){super(e),this.state={showGoto:!1,gotoValue:e.currentPage}}render(){const e=[],t=Math.max(this.props.totalPages-this.props.currentPage-1,0),n=Math.max(this.props.currentPage-2,0),d=Math.max(this.props.currentPage-Math.max(5-Number(this.props.currentPage!==this.props.totalPages)-t,2),2),h=Math.min(this.props.currentPage+Math.max(5-Number(1!==this.props.currentPage)-n,2),this.props.totalPages-1);for(let t=d;t<=h;t++)e.push(s.createElement(l.A.Item,{key:t,active:t===this.props.currentPage,onClick:()=>this.props.selectPage(t)},t));const p=this.props.totalPages>7?s.createElement(l.A.Ellipsis,{disabled:!0}):null,g=s.createElement(c.A,{id:"popover-gotopage"},s.createElement(c.A.Title,null,s.createElement(m.A,{id:"generic.goto.title"})),s.createElement(c.A.Content,null,s.createElement("form",{className:"d-flex",onSubmit:e=>{e.preventDefault(),this.props.selectPage(this.state.gotoValue),this.setState({showGoto:!1})}},s.createElement(i.A.Control,{className:"mr-2",type:"number",min:1,max:this.props.totalPages,value:this.state.gotoValue,onChange:e=>this.setState({gotoValue:parseInt(e.target.value)}),custom:!0}),s.createElement(a.A,{type:"submit"},s.createElement(m.A,{id:"generic.goto"}))))),{selectPage:y,totalPages:w,currentPage:A,...E}=this.props;return s.createElement("div",u({className:"text-center",style:{position:"sticky",bottom:"1.5em"}},E),s.createElement(l.A,{className:"justify-content-center"},s.createElement(l.A.Prev,{disabled:this.props.currentPage<=1,onClick:()=>this.props.selectPage(Math.max(this.props.currentPage-1,1))}),s.createElement(l.A.Item,{active:this.props.currentPage<=1,onClick:()=>this.props.selectPage(1)},"1"),p,e,p,this.props.totalPages>=2?s.createElement(l.A.Item,{active:this.props.currentPage>=this.props.totalPages,onClick:()=>this.props.selectPage(this.props.totalPages)},this.props.totalPages):null,this.props.totalPages>7?s.createElement(o.A,{show:this.state.showGoto,placement:"top",overlay:g},s.createElement(l.A.Item,{onClick:()=>this.setState((e=>({showGoto:!e.showGoto})))},s.createElement(r.g,{icon:"search"}))):null,s.createElement(l.A.Next,{disabled:this.props.currentPage>=this.props.totalPages,onClick:()=>this.props.selectPage(Math.min(this.props.currentPage+1,this.props.totalPages))})))}}},4717:function(e,t,n){n.r(t);var r=n(6188),s=n(6784),a=n(6540),i=n(5615),o=n(1208),l=n(1364),c=n(5192),m=n(5038),u=n(3524),d=n(8065),h=n(9013),p=n(2576),g=n(4173),y=n(5301),w=n(379),A=n(7621),E=n(4580),f=n(4118),v=n(664),b=n(7567),V=n(5659),P=n(6795),O=n(7255),R=n(5282);function C(){return C=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)({}).hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},C.apply(null,arguments)}class S extends a.Component{constructor(e){super(e);const t={version:"514.1589",engine:p.p3.Byond},n={engine:p.p3.OpenDream,sourceSHA:"fab769776dada6b9bcad546094d78c604049e0e9"};this.state={versions:[],errors:[],latestByondVersion:t,latestODVersion:n,loading:!0,page:v.M2.byondlistpage??1}}addError(e){this.setState((t=>{const n=Array.from(t.errors);return n.push(e),{errors:n}}))}async loadVersions(){if((0,f.Dp)(this.context.instancePermissionSet,p.em.ListInstalled)){const e=await h.A.listAllVersions(this.context.instance.id,{page:this.state.page});if(e.code===y.s.OK){if(this.state.page>e.payload.totalPages&&0!==e.payload.totalPages)return void this.setState({page:1});this.setState({versions:e.payload.content,maxPage:e.payload.totalPages})}else this.addError(e.error)}if((0,f.Dp)(this.context.instancePermissionSet,p.em.ReadActive)){const e=await h.A.getActiveVersion(this.context.instance.id);e.code===y.s.OK?this.setState({activeVersion:e.payload.engineVersion}):this.addError(e.error)}}async switchVersion(e,t){this.setState({loading:!0});const n=await h.A.switchActive(this.context.instance.id,e,t&&this.state.customFile?await this.state.customFile.arrayBuffer():void 0);n.code===y.s.ERROR?this.addError(n.error):(t&&this.setState({customFile:null}),n.payload.installJob?(w.default.registerJob(n.payload.installJob,this.context.instance.id),w.default.registerCallback(n.payload.installJob.id,(()=>{this.loadVersions()}))):await this.loadVersions()),this.setState({loading:!1})}componentDidUpdate(e,t){t.page!==this.state.page&&(v.M2.byondlistpage=this.state.page,this.loadVersions())}componentDidMount(){const e=E.A.getLatestDefaultCommit("OpenDreamProject","OpenDream");fetch("https://secure.byond.com/download/version.txt").then((e=>e.text())).then((e=>e.split("\n"))).then((e=>e[0])).then((e=>{const t={engine:p.p3.Byond,version:e};this.setState({latestByondVersion:t,selectedByondVersion:t,loading:!1})})).catch((e=>{this.addError(new g.Ay(g.O4.APP_FAIL,{jsError:Error(e)})),this.setState({loading:!1})})),(async()=>{await this.loadVersions();const t=await e;if(t.code===y.s.ERROR)return void this.addError(t.error);const n={engine:p.p3.OpenDream,sourceSHA:t.payload};this.setState((e=>({latestODVersion:n,selectedODVersion:this.makeUniqueStringForVersion(e.latestODVersion)==this.makeUniqueStringForVersion(e.selectedODVersion??e.latestODVersion)?n:e.selectedODVersion})))})()}render(){if(this.state.loading)return a.createElement(O.default,{text:"loading.byond"});const e=(0,f.Dp)(this.context.instancePermissionSet,p.em.ListInstalled),t=(0,f.Dp)(this.context.instancePermissionSet,p.em.ReadActive),n=(0,f.Dp)(this.context.instancePermissionSet,p.em.InstallOfficialOrChangeActiveByondVersion),o=(0,f.Dp)(this.context.instancePermissionSet,p.em.InstallOfficialOrChangeActiveOpenDreamVersion),l=(0,f.Dp)(this.context.instancePermissionSet,p.em.DeleteInstall);return a.createElement("div",{className:"text-center"},a.createElement(P.Q,{obj:this.state}),a.createElement("h1",null,a.createElement(d.A,{id:"view.instance.engine"})),this.state.errors.map(((e,t)=>{if(e)return a.createElement(b.Ay,{key:t,error:e,onClose:()=>this.setState((e=>{const n=Array.from(e.errors);return n[t]=void 0,{errors:n}}))})})),e?a.createElement(a.Fragment,null,t?null:a.createElement(V.A,{title:"view.instance.engine.current_denied"}),a.createElement("div",null,this.state.versions.map((e=>a.createElement(c.A,{className:"w-md-25 mb-1 mx-auto d-flex",key:this.makeUniqueStringForVersion(e.engineVersion)},n||t?a.createElement(c.A.Prepend,null,a.createElement(c.A.Radio,{name:"byond",id:this.makeUniqueStringForVersion(e.engineVersion),value:S.friendlyVersion(e.engineVersion),disabled:e.engineVersion.engine===p.p3.Byond?!n:e.engineVersion.engine===p.p3.OpenDream&&!o,checked:this.makeUniqueStringForVersion(e.engineVersion)===this.makeUniqueStringForVersion(this.state.activeVersion),onChange:async()=>{await this.switchVersion(e.engineVersion,!1)}})):null,a.createElement("label",{className:"flex-grow-1 m-0",htmlFor:this.makeUniqueStringForVersion(e.engineVersion)},a.createElement(m.A,{overlay:this.tooltip("view.instance.engine.custom"),show:!!e.engineVersion.customIteration&&void 0},(({ref:t,...n})=>a.createElement(c.A.Text,C({className:"w-100"},n),S.friendlyVersion(e.engineVersion),e.engineVersion.customIteration?a.createElement("div",{className:"ml-auto",ref:t},a.createElement(s.g,{fixedWidth:!0,icon:"info"})):null)))),this.makeUniqueStringForVersion(e.engineVersion)!==this.makeUniqueStringForVersion(this.state.activeVersion)?a.createElement(c.A.Append,null,a.createElement(m.A,{overlay:this.tooltip("generic.no_perm"),show:!l&&void 0},a.createElement(i.A,{variant:"danger",disabled:!l,onClick:()=>{(async()=>{this.setState({loading:!0});const t=await h.A.deleteVersion(this.context.instance.id,e.engineVersion);t.code===y.s.ERROR?this.addError(t.error):(w.default.registerJob(t.payload,this.context.instance.id),w.default.registerCallback(t.payload.id,(()=>{this.loadVersions()}))),this.setState({loading:!1})})()}},a.createElement(s.g,{icon:r.yLS})))):null)))),a.createElement(R.A,{className:"mt-4",selectPage:e=>this.setState({page:e}),totalPages:this.state.maxPage??1,currentPage:this.state.page})):t?a.createElement(a.Fragment,null,a.createElement(V.A,{title:"view.instance.engine.list_denied"}),a.createElement(d.A,{id:"view.instance.engine.current_version",values:{version:this.state.activeVersion}})):a.createElement(V.A,{title:"view.instance.engine.current_and_list_denied"}),a.createElement("hr",null),this.renderByondInstall(),a.createElement("hr",null),this.renderODInstall())}tooltip(e){return e?a.createElement(u.A,{id:e},a.createElement(d.A,{id:e})):a.createElement(a.Fragment,null)}renderByondInstall(){const e=(0,f.Dp)(this.context.instancePermissionSet,p.em.InstallCustomByondVersion),t=(0,f.Dp)(this.context.instancePermissionSet,p.em.InstallOfficialOrChangeActiveByondVersion);return a.createElement(a.Fragment,null,a.createElement("h4",null,a.createElement(d.A,{id:"view.instance.engine.add_byond"})),a.createElement(c.A,{className:"w-md-50 w-lg-25 mb-3 mx-auto"},a.createElement(l.A,{type:"number",defaultValue:this.state.latestByondVersion.version.split(".")[0],onChange:e=>{this.setState((t=>{const n=(t.selectedByondVersion??t.latestByondVersion).version.split(".");return n[0]=e.target.value,{selectedByondVersion:{engine:p.p3.Byond,version:n.join(".")}}}))}}),a.createElement(c.A.Text,{className:"rounded-0"},"."),a.createElement(l.A,{type:"number",defaultValue:this.state.latestByondVersion.version.split(".")[1],onChange:e=>{this.setState((t=>{const n=(t.selectedByondVersion??t.latestByondVersion).version.split(".");return n[1]=e.target.value,{selectedByondVersion:{engine:p.p3.Byond,version:n.join(".")}}}))}}),a.createElement(c.A.Append,null,a.createElement(m.A,{overlay:this.tooltip("generic.no_perm"),show:!t&&void 0},a.createElement(i.A,{variant:"success",disabled:!t,onClick:()=>{(async()=>{await this.switchVersion(this.state.selectedByondVersion??this.state.latestByondVersion,!0)})()}},a.createElement(s.g,{icon:r.QLR}))))),a.createElement(o.A,null,a.createElement(m.A,{overlay:this.tooltip("generic.no_perm"),show:!e&&void 0},a.createElement(o.A.File,{custom:!0,id:"test",disabled:!e,className:"w-md-50 w-lg-25 text-left",label:this.state.customFile?this.state.customFile.name:a.createElement(d.A,{id:"view.instance.engine.upload"}),accept:".zip",onChange:e=>{this.setState({customFile:e.target.files?e.target.files[0]:null})}}))))}renderODInstall(){const e=(0,f.Dp)(this.context.instancePermissionSet,p.em.InstallCustomOpenDreamVersion),t=(0,f.Dp)(this.context.instancePermissionSet,p.em.InstallOfficialOrChangeActiveOpenDreamVersion);return a.createElement(a.Fragment,null,a.createElement("h4",null,a.createElement(d.A,{id:"view.instance.engine.add_od"})),a.createElement(c.A,{className:"w-md-50 w-lg-25 mb-3 mx-auto"},a.createElement(l.A,{type:"string",defaultValue:this.state.latestODVersion.sourceSHA,value:(this.state.selectedODVersion??this.state.latestODVersion).sourceSHA,onChange:e=>{this.setState({selectedODVersion:{engine:p.p3.OpenDream,sourceSHA:e.target.value}})}}),a.createElement(c.A.Append,null,a.createElement(m.A,{overlay:this.tooltip("generic.no_perm"),show:!t&&void 0},a.createElement(i.A,{variant:"success",disabled:!t,onClick:()=>{(async()=>{await this.switchVersion(this.state.selectedODVersion??this.state.latestODVersion,!0)})()}},a.createElement(s.g,{icon:r.QLR}))))),a.createElement(o.A,null,a.createElement(m.A,{overlay:this.tooltip("generic.no_perm"),show:!e&&void 0},a.createElement(o.A.File,{custom:!0,id:"test",disabled:!e,className:"w-md-50 w-lg-25 text-left",label:this.state.customFile?this.state.customFile.name:a.createElement(d.A,{id:"view.instance.engine.upload"}),accept:".zip",onChange:e=>{this.setState({customFile:e.target.files?e.target.files[0]:null})}}))))}makeUniqueStringForVersion(e){return e?`${e.engine}-${e.version??"null"}-${e.sourceSHA??"null"}-${e.customIteration??"null"}`:"null-version"}static friendlyVersion(e){let t;switch(e.engine){case p.p3.Byond:t=e.version,t.endsWith(".0")&&(t=t.substring(0,t.length-2));break;case p.p3.OpenDream:t=`OD-${e.sourceSHA.substring(0,7)}`;break;default:throw new Error(`Unknown engine type: ${e.engine}`)}return e.customIteration?`${t} (${e.customIteration})`:t}}S.contextType=A.z,t.default=S},7621:function(e,t,n){n.d(t,{z:function(){return r}});const r=n(6540).createContext(void 0)},4580:function(e,t,n){n.d(t,{A:function(){return g}});var r=n(3441),s=n(8763),a=n(3437),i=n(4101),o=n(4173),l=n(5301),c=n(8437),m=n(7602);var u=e=>new Promise((t=>{setTimeout(t,e)}));async function d(e,t,n){const r=e.endpoint.merge(t,n);return c.Ay.githubtoken.value&&(r.headers.authorization=`token ${c.Ay.githubtoken.value}`),e(r)}async function h(){return c.Ay.githubtoken.value?{type:"token",tokenType:"pat",token:c.Ay.githubtoken.value}:{type:"unauthenticated"}}const p=()=>Object.assign(h.bind(null),{hook:d.bind(null)});var g=new class extends i.TypedEmitter{constructor(){super(),this.apiClient=void 0;const e=a.E.plugin(r.L,s.A);this.apiClient=new e({authStrategy:p,userAgent:"tgstation-server-control-panel/"+m.xv,baseUrl:"https://api.github.com",throttle:{onRateLimit:(e,t)=>(console.warn(`Request quota exhausted for request ${t.method} ${t.url}`),0===t.request.retryCount&&(console.log(`Retrying after ${e} seconds!`),!0)),onSecondaryRateLimit:(e,t)=>{console.warn(`Abuse detected for request ${t.method} ${t.url}`)}}})}async getLatestDefaultCommit(e,t){try{const n=await this.apiClient.repos.get({owner:e,repo:t}),r=await this.apiClient.repos.getBranch({owner:e,repo:t,branch:n.data.default_branch});return new l.A({code:l.s.OK,payload:r.data.commit.sha})}catch(e){return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}}async getVersions({owner:e,repo:t,current:n,all:r}){let s,a=0;try{s=await this.apiClient.paginate(this.apiClient.repos.listReleases,{owner:e,repo:t},((e,t)=>e.data.reduce(((e,s)=>{const i=/tgstation-server-v([\d.]+)/.exec(s.name??"");if(!i)return e;if(parseInt(i[1][0])<4)return e;const o=i[1];let l=!1;if(o<=n){if(a>=3&&!r)return t(),e;a++,l=!0}return e.push({version:o,body:s.body??"",current:o===n,old:l}),e}),[])))}catch(e){return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}return new l.A({code:l.s.OK,payload:s})}transformPR(e){return{number:e.number,title:e.title,author:e.user?.login??"ghost",state:e.merged_at?"merged":e.state,link:e.html_url,head:e.head.sha,tail:e.base.sha,testmergelabel:e.labels.some((e=>e.name?.toLowerCase().includes("testmerge")||e.name?.toLowerCase().includes("test merge"))),mergeable:e.mergeable}}transformPR2(e){return{number:e.number,title:e.title,author:e.user?.login??"ghost",state:e.merged_at?"merged":e.state,link:e.html_url,head:e.head.sha,tail:e.base.sha,testmergelabel:e.labels.some((e=>e.name?.toLowerCase().includes("testmerge")||e.name?.toLowerCase().includes("test merge"))),mergeable:null}}async getPR({owner:e,repo:t,wantedPR:n}){const r=await this.apiClient.pulls.get({owner:e,repo:t,pull_number:n});return this.transformPR(r.data)}async getPRUntilMergeable({owner:e,repo:t,wantedPR:n}){for(let r=0;r<2;r++){const r=await this.getPR({owner:e,repo:t,wantedPR:n});if(null!==r.mergeable)return r;await u(5e3)}return this.getPR({owner:e,repo:t,wantedPR:n})}async getPRs({owner:e,repo:t,wantedPRs:n}){let r=[];try{const s=await this.apiClient.paginate(this.apiClient.pulls.list,{owner:e,repo:t,state:"open"});if(c.Ay.githubtoken.value&&c.Ay.githubtoken.value.length>0){const a=s.map((e=>e.number));for(const e of n??[])a.includes(e)||a.push(e);const i=a.map((n=>this.getPRUntilMergeable({owner:e,repo:t,wantedPR:n})));r=await Promise.all(i)}else{r=s.map(this.transformPR2);for(const s of n??[])if(!r.find((e=>e.number==s))){const n=(await this.apiClient.pulls.get({owner:e,repo:t,pull_number:s})).data;r.push(this.transformPR(n))}}}catch(e){return console.error(e),new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}return new l.A({code:l.s.OK,payload:r})}async getPRCommits({owner:e,repo:t,pr:n,wantedCommit:r}){let s,a=[];try{if(a=await this.apiClient.paginate(this.apiClient.pulls.listCommits,{owner:e,repo:t,pull_number:n.number,per_page:100},(({data:e})=>e.map((e=>({name:e.commit.message.split("\n")[0],sha:e.sha,url:e.html_url}))))),a.reverse(),r&&!a.find((e=>e.sha===r))){const n=(await this.apiClient.repos.getCommit({owner:e,repo:t,ref:r})).data;s={name:n.commit.message.split("\n")[0],sha:n.sha,url:n.html_url}}}catch(e){return console.error(e),new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}return new l.A({code:l.s.OK,payload:[a,s]})}async getFile(e,t,n,r){try{const{data:s}=await this.apiClient.repos.getContent({mediaType:{format:"base64"},owner:e,repo:t,path:n,ref:r});if(Array.isArray(s))return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:new Error(`${n} was a directory!`)})});if("file"!==s.type)return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:new Error(`${n} has type ${s.type}!`)})});const a=s.content;return new l.A({code:l.s.OK,payload:a})}catch(e){return console.error(e),new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}}async getDirectoryContents(e,t,n,r){try{const{data:s}=await this.apiClient.repos.getContent({owner:e,repo:t,path:n,ref:r});if(!Array.isArray(s))return new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:new Error(`${n} was not a directory!`)})});const a=[];return s.forEach((e=>a.push({path:e.path,isDirectory:"dir"==e.type}))),new l.A({code:l.s.OK,payload:a})}catch(e){return console.error(e),new l.A({code:l.s.ERROR,error:new o.Ay(o.O4.GITHUB_FAIL,{jsError:e})})}}}}}]);
//# sourceMappingURL=4717.b7697effb54b8670bc2c.bundle.js.map
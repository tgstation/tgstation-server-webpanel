"use strict";(self.webpackChunktgstation_server_control_panel=self.webpackChunktgstation_server_control_panel||[]).push([[9496],{9496:function(e,t,s){s.r(t);var r=s(6784),n=s(6540),i=s(5677),a=s(1948),o=s(1008),c=s(1105),m=s(5192),l=s(1208),d=s(5615),u=s(5038),h=s(3524),p=s(8065),g=s(4180),E=s(2576),S=s(1824),P=s(2589),f=s(4173),A=s(5301),y=s(1552),b=s(1903),x=s(7621),v=s(4118),w=s(664),k=s(7567),C=s(1723),R=s(6795),O=s(7255);function I(){return I=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var s=arguments[t];for(var r in s)({}).hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},I.apply(null,arguments)}class K extends n.Component{constructor(e){super(e),this.loadCurrentPermissions=this.loadCurrentPermissions.bind(this),this.createPermissionSetForCurrent=this.createPermissionSetForCurrent.bind(this),this.grantPermissions=this.grantPermissions.bind(this),this.state={errors:[],loading:!0,loadingPerms:!0,instanceNeedsReload:!1,tab:"instancepermissionsetperms",userPermissions:{permissionSetId:0,instancePermissionSetRights:0,repositoryRights:0,engineRights:0,dreamMakerRights:0,dreamDaemonRights:0,chatBotRights:0,configurationRights:0},currentPermissions:null,selectedPermissionSetId:0,permsinstancepermissionset:{},permsrepository:{},permsengine:{},permsdreammaker:{},permsdreamdaemon:{},permschatbots:{},permsconfiguration:{}}}loadEnums(e){this.setState({currentPermissions:e});const t=(t,s,r)=>{Object.entries(t).forEach((([t,n])=>{if(!isNaN(parseInt(t)))return;const i=t.toLowerCase(),a=n;if("none"==i)return;const o=!!(e[s]&a);this.setState((e=>({[r]:{...e[r],[i]:{currentVal:o,bitflag:a}}})))}))};t(E.SK,"instancePermissionSetRights","permsinstancepermissionset"),t(E.WX,"repositoryRights","permsrepository"),t(E.em,"engineRights","permsengine"),t(E.rY,"dreamMakerRights","permsdreammaker"),t(E.NB,"dreamDaemonRights","permsdreamdaemon"),t(E.B5,"chatBotRights","permschatbots"),t(E.qd,"configurationRights","permsconfiguration")}addError(e){this.setState((t=>{const s=Array.from(t.errors);return s.push(e),{errors:s}}))}async loadCurrentPermissions(e){if(this.setState({loadingPerms:!0}),e===(0,v.u)(this.context.user).id){const e=new Promise((e=>setTimeout(e,200))),t=await P.A.getCurrentInstancePermissionSet(this.context.instance.id,!0);await e,t.code===A.s.OK?(this.setState({userPermissions:t.payload}),this.loadEnums(t.payload)):this.addError(t.error)}else if((0,v.O2)(this.context.instancePermissionSet,E.SK.Read)){const t=await P.A.getByPermissionSetId(this.context.instance.id,e);t.code===A.s.OK?this.loadEnums(t.payload):t.error.code==f.O4.NO_DB_ENTITY?this.setState({currentPermissions:null}):this.addError(t.error)}this.setState({loadingPerms:!1})}async loadUsersAndGroups(){const e=(0,v.u)(this.context.user);if(!(0,v.CM)(e,E.O4.ReadUsers))return void this.setState({groups:null,users:null});let t=!1;const s=y.A.listUsers({page:1,pageSize:100}),r=await b.A.listGroups({page:1,pageSize:100});t=!0,r.code===A.s.OK?this.setState({groups:r.payload.content}):(this.addError(r.error),t=!1);const n=await s;n.code===A.s.OK?this.setState({users:n.payload.content.filter((e=>!e.group))}):(this.addError(n.error),t=!1),t||(this.context.user.group?this.setState({groups:[this.context.user.group],users:[]}):this.setState({groups:[],users:[this.context.user]}))}async loadAllPermissionSets(){let e=!1;if((0,v.O2)(this.context.instancePermissionSet,E.SK.Read)){const t=await P.A.listInstancePermissionSets(this.context.instance.id,{page:1,pageSize:100});t.code===A.s.OK?(this.setState({instancePermissionSets:t.payload.content}),e=!0):this.addError(t.error)}e||this.setState({instancePermissionSets:[this.context.instancePermissionSet]})}async createPermissionSetForCurrent(){const e=await P.A.createInstancePermissionSet(this.context.instance.id,{permissionSetId:this.state.selectedPermissionSetId});e.code!=A.s.OK?this.addError(e.error):this.setState({currentPermissions:e.payload})}async grantPermissions(){const e=await S.A.grantPermissions({id:this.context.instance.id});e.code!=A.s.OK?this.addError(e.error):await this.loadCurrentPermissions(this.state.selectedPermissionSetId)}async deletePermissionSet(){if(!confirm("Are you sure you want to delete this permission set? The selected user/group will lose access to the instance."))return;const e=await P.A.deleteInstancePermissionSet(this.context.instance.id,this.state.selectedPermissionSetId);e.code!=A.s.OK&&e.error.code!=f.O4.NO_DB_ENTITY?this.addError(e.error):this.state.selectedPermissionSetId===(0,v.u)(this.context.user).id?(w.M2.selectedinstanceid=void 0,this.props.history.push(w.Sb.instancelist.link??w.Sb.instancelist.route)):this.setState({currentPermissions:null})}async componentDidMount(){const e=(0,v.u)(this.context.user).id;this.setState({selectedPermissionSetId:e,userPermissions:this.context.instancePermissionSet});const t=this.loadCurrentPermissions(e),s=this.loadAllPermissionSets();await this.loadUsersAndGroups(),await t,await s,this.setState({loading:!1})}async componentWillUnmount(){this.state.instanceNeedsReload&&await this.context.reloadInstance()}render(){if(this.state.loading)return n.createElement(O.default,{text:"loading.instance.perms"});const e=new Map,t={};if(this.state.users&&this.state.groups)this.state.users?.forEach((s=>{const r=`User: ${s.name}${s.id===this.context.user.id?" (You)":""}`;e.set(r,s.permissionSet.id),t[r]=s.permissionSet.id})),this.state.groups?.forEach((s=>{const r=`Group: ${s.name}${s.id===this.context.user.group?.id?" (Your Group)":""}`;e.set(r,s.permissionSet.id),t[r]=s.permissionSet.id}));else{if(this.context.user.group){const s=`Group: ${this.context.user.group.name} (Your Group)`;e.set(s,this.context.user.group.permissionSet.id),t[s]=this.context.user.group.permissionSet.id}else{const s=`User: ${this.context.user.name} (You)`;e.set(s,this.context.user.permissionSet.id),t[s]=this.context.user.permissionSet.id}this.state.instancePermissionSets?.forEach((s=>{if(s.permissionSetId===(0,v.u)(this.context.user).id)return;const r=`Permission Set ${s.permissionSetId}`;e.set(r,s.permissionSetId),t[r]=s.permissionSetId}))}return n.createElement("div",{className:"text-center"},n.createElement("h1",null,n.createElement(p.A,{id:"view.instance.perms"})),n.createElement(R.Q,{obj:this.state}),this.state.errors.map(((e,t)=>{if(e)return n.createElement(k.Ay,{key:t,error:e,onClose:()=>this.setState((e=>{const s=Array.from(e.errors);return s[t]=void 0,{errors:s}}))})})),n.createElement(C.Ay,{name:"fields.instance.perms.owner",type:C.PU.Enum,enum:t,noLocalize:!0,defaultValue:this.state.selectedPermissionSetId,disabled:this.context.instancePermissionSet.instancePermissionSetRights===E.SK.None,onChange:e=>{this.setState({selectedPermissionSetId:e}),this.loadCurrentPermissions(e)}}),n.createElement("hr",null),this.renderPermissionEditor())}renderPermissionEditor(){if(this.state.loadingPerms)return n.createElement(O.default,{text:"loading.perms"});let e=!1,t=n.createElement(n.Fragment,null);const s=(0,v.u)(this.context.user);if(s.id!==this.state.selectedPermissionSetId||!(0,v.tL)(s,E.cq.GrantPermissions)||this.state.currentPermissions&&(0,v.O2)(this.state.currentPermissions,E.SK.Write)||(e=!0,t=n.createElement(n.Fragment,null,n.createElement("hr",null),n.createElement("h5",null,n.createElement(p.A,{id:"view.instance.perms.grant.desc"})),n.createElement(d.A,{variant:"success",onClick:()=>{this.grantPermissions()}},n.createElement(p.A,{id:"view.instance.perms.grant"})))),!this.state.currentPermissions){const t=(0,v.O2)(this.state.userPermissions,E.SK.Create);return n.createElement("div",{className:"text-center mt-2"},n.createElement("h3",null,n.createElement(p.A,{id:"view.instance.perms.missing"})),e?n.createElement(n.Fragment,null):n.createElement(n.Fragment,null,n.createElement("br",null),n.createElement(u.A,{placement:"top",overlay:e=>n.createElement(h.A,I({id:"create-ips-tooltop"},e),n.createElement(p.A,{id:"view.instance.perms.create"}))},n.createElement(d.A,{variant:"success",disabled:!t,onClick:()=>{this.createPermissionSetForCurrent()}},n.createElement(p.A,{id:"view.instance.perms.create"})))))}return n.createElement(n.Fragment,null,this.renderEditorTabs(),t)}renderEditorTabs(){const e=(0,v.O2)(this.state.userPermissions,E.SK.Write);return n.createElement(n.Fragment,null,e?n.createElement(n.Fragment,null):n.createElement(i.A,{className:"clearfix",variant:"error"},n.createElement(p.A,{id:"perms.instancepermissionset.cantedit"})),n.createElement(a.A,{activeKey:this.state.tab,onSelect:e=>{e&&this.setState({tab:e})},id:"permission-tabs",className:"justify-content-center mb-3 mt-4 flex-column flex-md-row"},n.createElement(o.A,{eventKey:"instancepermissionsetperms",title:n.createElement(p.A,{id:"perms.instancepermissionset"})},this.renderPerms("permsinstancepermissionset","instancepermissionset",e)),n.createElement(o.A,{eventKey:"repositoryperms",title:n.createElement(p.A,{id:"perms.repository"})},this.renderPerms("permsrepository","repository",e)),n.createElement(o.A,{eventKey:"engineperms",title:n.createElement(p.A,{id:"perms.engine"})},this.renderPerms("permsengine","engine",e)),n.createElement(o.A,{eventKey:"dreammakerperms",title:n.createElement(p.A,{id:"perms.dreammaker"})},this.renderPerms("permsdreammaker","dreammaker",e)),n.createElement(o.A,{eventKey:"dreamdaemonperms",title:n.createElement(p.A,{id:"perms.dreamdaemon"})},this.renderPerms("permsdreamdaemon","dreamdaemon",e)),n.createElement(o.A,{eventKey:"chatbotsperms",title:n.createElement(p.A,{id:"perms.chatbots"})},this.renderPerms("permschatbots","chatbots",e)),n.createElement(o.A,{eventKey:"configurationperms",title:n.createElement(p.A,{id:"perms.configuration"})},this.renderPerms("permsconfiguration","configuration",e))),"instancepermissionsetperms"===this.state.tab&&e?n.createElement(n.Fragment,null,n.createElement("br",null),n.createElement(d.A,{variant:"danger",onClick:()=>{this.deletePermissionSet()}},n.createElement(p.A,{id:"view.instance.perms.delete"}))):n.createElement(n.Fragment,null))}renderPerms(e,t,s){const i={},a=(e,t,s)=>{e.current&&t.current&&(e.current.checked!==s?t.current.classList.add("font-weight-bold"):t.current.classList.remove("font-weight-bold"))},o=t=>()=>{for(const[s,r]of Object.entries(i)){if(!r.input.current)return;r.input.current.checked=t,a(r.input,r.field,this.state[e][s].currentVal)}},g=async()=>{this.setState({loadingPerms:!0});let t,s=0;for(const[t,r]of Object.entries(i))r.input.current&&(s+=r.input.current.checked?this.state[e][t].bitflag:0);if(!this.state.currentPermissions)return void this.addError(new f.Ay(f.O4.APP_FAIL,{jsError:Error("this.state.user is null in user edit save")}));switch(e){case"permsinstancepermissionset":t="InstancePermissionSetRights";break;case"permsrepository":t="RepositoryRights";break;case"permsengine":t="EngineRights";break;case"permsdreammaker":t="DreamMakerRights";break;case"permsdreamdaemon":t="DreamDaemonRights";break;case"permschatbots":t="ChatBotRights";break;case"permsconfiguration":t="ConfigurationRights"}const r=Object.assign(Object.assign({},this.state.currentPermissions),{[t]:s}),n=await P.A.updateInstancePermissionSet(this.context.instance.id,r);n.code==A.s.OK?(r.permissionSetId===this.state.userPermissions?.permissionSetId&&this.setState({userPermissions:n.payload,instanceNeedsReload:!0}),this.loadEnums(n.payload)):this.addError(n.error),this.setState({loadingPerms:!1})};return n.createElement(n.Fragment,null,s?n.createElement(n.Fragment,null,n.createElement("h5",null,n.createElement(p.A,{id:"generic.setall"})),n.createElement(d.A,{onClick:o(!0)},n.createElement(p.A,{id:"generic.true"}))," ",n.createElement(d.A,{onClick:o(!1)},n.createElement(p.A,{id:"generic.false"}))," ",n.createElement(d.A,{onClick:()=>{for(const[t,s]of Object.entries(i))s.input.current&&(s.input.current.checked=this.state[e][t].currentVal,a(s.input,s.field,this.state[e][t].currentVal))}},n.createElement(p.A,{id:"generic.reset"}))):"",n.createElement(c.A,{md:8,lg:7,xl:6,className:"mx-auto"},n.createElement("hr",null),Object.entries(this.state[e]).map((([o,c])=>{const d=n.createRef(),g=n.createRef();return i[o]={input:d,field:g},n.createElement(m.A,{key:`${e}.${o}`,as:"label",htmlFor:o,className:"mb-0"},n.createElement(m.A.Prepend,{className:"flex-grow-1 overflow-auto"},n.createElement(u.A,{overlay:n.createElement(h.A,{id:`perms.${t}.${o}.desc`},n.createElement(p.A,{id:`perms.${t}.${o}.desc`}))},(({ref:i,...u})=>n.createElement(m.A.Text,{className:"flex-fill",ref:g},n.createElement("div",u,n.createElement(p.A,{id:`perms.${t}.${o}`})),n.createElement("div",{className:"ml-auto d-flex align-items-center"},n.createElement(l.A.Check,{inline:!0,type:"switch",custom:!0,id:`${e}.${o}`,className:"d-flex justify-content-center align-content-center mx-2",label:"",ref:d,disabled:!s,defaultChecked:c.currentVal,onChange:()=>{a(d,g,c.currentVal)}}),n.createElement("div",I({},u,{ref:i}),n.createElement(r.g,{fixedWidth:!0,icon:"info"}))))))))})),n.createElement("hr",null)),s?n.createElement(d.A,{onClick:()=>{g()}},n.createElement(p.A,{id:"generic.savetab"})):"")}}K.contextType=x.z,t.default=(0,g.y)(K)}}]);
//# sourceMappingURL=9496.e93d876256e7c8811451.bundle.js.map